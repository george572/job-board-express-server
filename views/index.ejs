<!DOCTYPE html>
<html lang="ka">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <%- include('partials/head-meta', { seo }) %>
  <!-- WebSite schema for sitelinks / knowledge panel -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Samushao.ge",
      "url": "https://samushao.ge",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://samushao.ge/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
  </script>
  <!-- BreadcrumbList: მთავარი > ვაკანსიები -->
  <script type="application/ld+json">
    {"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"მთავარი","item":"https://samushao.ge/"},{"@type":"ListItem","position":2,"name":"ვაკანსიები","item":"<%= (seo && seo.canonical) ? seo.canonical : 'https://samushao.ge/' %>"}]}
  </script>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <% if (currentPage > 1) { %>
  <link rel="prev" href="https://samushao.ge/<%= currentPage === 2 ? '' : '?page=' + (currentPage - 1) %>">
  <% } %>
  <% if (currentPage < totalPages) { %>
  <link rel="next" href="https://samushao.ge/?page=<%= currentPage + 1 %>">
  <% } %>
</head>

<body class="font-markgeo text-secondary bg-[#F8F9FA]">
  <%- include('partials/header') %>
  <%- include('partials/filters') %>

  <!-- Top salary jobs slider (hidden when any filter is active; JS toggles visibility on filter change) -->
  <% if (topSalaryJobs && topSalaryJobs.length > 0) { %>
  <section id="top-salary-slider-section" class="w-full mx-auto px-4 mt-6 mb-4" style="<%= filtersActive ? 'display:none' : '' %>">
    <div class="mx-auto">
      <div class="flex items-center justify-between mb-4 gap-3">
        <h2 class="font-kolkha text-[18px] sm:text-[22px] text-[#151515] flex-1">
          ყველაზე მაღალანაზღაურებადი ვაკანსიები
        </h2>
        <div class="flex items-center gap-2 flex-shrink-0">
          <button class="top-salary-prev w-8 h-8 sm:w-10 sm:h-10 rounded-full border border-gray-200 bg-white flex items-center justify-center hover:bg-[#F5F8FF] text-sm sm:text-base" aria-label="Prev">
            ←
          </button>
          <button class="top-salary-next w-8 h-8 sm:w-10 sm:h-10 rounded-full border border-gray-200 bg-white flex items-center justify-center hover:bg-[#F5F8FF] text-sm sm:text-base" aria-label="Next">
            →
          </button>
        </div>
      </div>

      <div class="swiper top-salary-swiper">
        <div class="swiper-wrapper">
          <% topSalaryJobs.forEach(job => { %>
          <div class="swiper-slide" style="height: auto;">
            <%- include('partials/jobItemCompact.ejs', { job, slugify }) %>
          </div>
          <% }) %>
        </div>
      </div>
    </div>
  </section>
  <% } %>

  <!-- Jobs area (replaced without reload when filters change) -->
  <div id="jobs-area" data-current-page="<%= currentPage || 1 %>" data-total-pages="<%= totalPages || 1 %>">
  <h1 id="all-vacancies-heading" class="font-kolkha text-[18px] sm:text-[22px] text-[#151515] flex-1 pb-4 w-full mx-auto px-4" style="<%= filtersActive ? 'display:none' : '' %>">
    ყველა ვაკანსია
  </h1>
  <div class="w-full relative mx-auto px-4" id="jobs-container">
    <% if (jobs && jobs.length > 0) { %>
    <% jobs.forEach(job => { %>
    <%- include('partials/jobItem.ejs', { job, slugify }) %>
    <% }) %>
    <% } else { %>
    <div class="text-center py-12">
      <p class="text-gray-500">სამუშაოები არ მოიძებნა</p>
    </div>
    <% } %>
  </div>

  <!-- Loading indicator -->
  <div id="loading-indicator" style="display: none; text-align: center; padding: 20px; color: #999; font-size: 14px;">
    იტვირთება...
  </div>


  <% if (totalPages > 1) { %>
  <nav class="pagination-small w-full flex justify-center items-center gap-2 py-4 transform scale-0">
    <% if (currentPage > 1) { %>
    <a href="/?page=<%= currentPage - 1 %>" class="p-2 bg-primary text-white rounded-xl">← წინა</a>
    <% } %>

    <% 
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) { %>
    <a href="/?page=1" class="p-2 bg-primary text-white rounded-xl min-w-[30px] text-center">1</a>
    <% if (startPage > 2) { %><span>...</span><% } %>
    <% }
    
    for (let i = startPage; i <= endPage; i++) { %>
    <a href="/?page=<%= i %>" class="<%= i === currentPage ? 'active' : '' %> p-2 bg-primary text-white rounded-xl min-w-[30px] text-center"><%= i %></a>
    <% }
    
    if (endPage < totalPages) { 
      if (endPage < totalPages - 1) { %><span>...</span><% } %>
    <a href="/?page=<%= totalPages %>" class="p-2 bg-primary text-white rounded-xl min-w-[30px] text-center"><%= totalPages %></a>
    <% } %>

    <% if (currentPage < totalPages) { %>
    <a href="/?page=<%= currentPage + 1 %>" class="p-2 bg-primary text-white rounded-xl">შემდეგი →</a>
    <% } %>
  </nav>
  <% } %>
  </div>
  <script>
    // Disable browser's automatic scroll restoration for all devices
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    // Category ID to name mapping
    const categoryNames = {
      '1': 'საოფისე',
      '2': 'მომხმარებელთან ურთიერთობები',
      '3': 'გაყიდვები',
      '4': 'საბანკო-საფინანსო',
      '5': 'საწყობი და წარმოება',
      '6': 'საცალო ვაჭრობა',
      '7': 'მზარეული',
      '8': 'აზარტული',
      '9': 'მენეჯმენტი',
      '10': 'ფარმაცია',
      '11': 'მიმტანი',
      '12': 'ინჟინერია',
      '13': 'ლოჯისტიკა',
      '14': 'სამედიცინო',
      '15': 'უსაფრთხოება',
      '16': 'დისტრიბუცია',
      '17': 'ინფორმაციული ტექნოლოგიები',
      '18': 'დიასახლისი',
      '19': 'სხვა',
      '20': 'ბუღალტერია'
    };

    const container = document.getElementById('jobs-container');
    let isLoading = false;
    
    // Cache for loaded pages to avoid re-fetching from server
    const pageCache = new Map();

    function bindNormalJobClicks(root) {
      try {
        const scope = root || document;
        const links = scope.querySelectorAll('#jobs-container a[data-job-id]');
        links.forEach(function (link) {
          if (link.__normalJobBound) return;
          link.__normalJobBound = true;
          link.addEventListener('click', function (e) {
            // Save scroll position and current page before navigating
            sessionStorage.setItem('jobListScrollPosition', window.scrollY.toString());
            sessionStorage.setItem('jobListCurrentPage', document.getElementById('jobs-area').dataset.currentPage);
            
            // Cache current HTML before leaving
            const jobsArea = document.getElementById('jobs-area');
            const currentPage = parseInt(jobsArea.dataset.currentPage || '1', 10);
            for (let i = 1; i <= currentPage; i++) {
              if (!pageCache.has(i)) {
                const pageHtml = document.getElementById('jobs-container').innerHTML;
                sessionStorage.setItem('cachedJobsHtml_' + currentPage, pageHtml);
              }
            }
            
            try {
              if (window.amplitude) {
                const categoryId = this.getAttribute('data-job-category');
                window.amplitude.track('Normal Job Clicked', {
                  job_id: this.getAttribute('data-job-id'),
                  job_category: categoryNames[categoryId] || categoryId,
                  job_title: this.getAttribute('data-job-title'),
                  salary_range: this.getAttribute('data-salary-range'),
                  company: this.getAttribute('data-job-company'),
                  location: this.getAttribute('data-job-location')
                });
              }
            } catch (e) {}
          });
        });
      } catch (e) {}
    }

    async function loadMoreJobs() {
      var jobsArea = document.getElementById('jobs-area');
      var currentPage = parseInt(jobsArea.dataset.currentPage || '1', 10);
      var totalPages = parseInt(jobsArea.dataset.totalPages || '1', 10);
      if (isLoading || currentPage >= totalPages) return;

      isLoading = true;

      // Show loading indicator
      document.getElementById('loading-indicator').style.display = 'block';

      currentPage++;
      
      // Check cache first
      const cached = pageCache.get(currentPage);
      if (cached) {
        document.getElementById('jobs-container').insertAdjacentHTML('beforeend', cached);
        jobsArea.dataset.currentPage = currentPage;
        bindNormalJobClicks(container);
        document.getElementById('loading-indicator').style.display = 'none';
        isLoading = false;
        return;
      }

      try {
        var params = new URLSearchParams(window.location.search);
        params.set('page', currentPage);

        var response = await fetch(`/?${params.toString()}`);
        var html = await response.text();

        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var newJobsHtml = doc.getElementById('jobs-container').innerHTML;

        // Cache the page
        pageCache.set(currentPage, newJobsHtml);

        document.getElementById('jobs-container').insertAdjacentHTML('beforeend', newJobsHtml);
        jobsArea.dataset.currentPage = currentPage;
        
        // Bind tracking to newly added normal job cards
        bindNormalJobClicks(container);

        // Hide loading indicator
        document.getElementById('loading-indicator').style.display = 'none';

        isLoading = false;
      } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('loading-indicator').style.display = 'none';
        isLoading = false;
      }
    }

// Reliable restore: disable bfcache if needed, then force-scroll
let isRestoring = false;

function checkAndRestoreScroll() {
  const savedScrollPosition = sessionStorage.getItem('jobListScrollPosition');
  const savedPage = sessionStorage.getItem('jobListCurrentPage');
  
  if (!savedScrollPosition || !savedPage || isRestoring) return;
  
  isRestoring = true;
  
  const targetPage = parseInt(savedPage, 10);
  const targetScroll = parseInt(savedScrollPosition, 10);
  const jobsArea = document.getElementById('jobs-area');
  const initialPage = parseInt(jobsArea.dataset.currentPage || '1', 10);
  
  // DISABLE BFCACHE if scroll restore needed (fixes mobile intermittency) [web:11]
  window.addEventListener('beforeunload', disableBFCache);
  function disableBFCache() {
    // Minimal handler evicts bfcache next back
    console.log('BFCache disabled for restore');
  }
  
  document.documentElement.style.scrollBehavior = 'auto';
  
  async function ensurePagesLoaded() {
    for (let page = initialPage + 1; page <= targetPage; page++) {
      let newJobsHtml = pageCache.get(page) || sessionStorage.getItem('cachedJobsHtml_' + page);
      if (!newJobsHtml) {
        const params = new URLSearchParams(window.location.search);
        params.set('page', page);
        const response = await fetch(`/?${params.toString()}`);
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        newJobsHtml = doc.getElementById('jobs-container').innerHTML;
        pageCache.set(page, newJobsHtml);
      }
      document.getElementById('jobs-container').insertAdjacentHTML('beforeend', newJobsHtml);
      jobsArea.dataset.currentPage = page;
    }
    bindNormalJobClicks(container);
  }
  
  const loadPromise = targetPage > initialPage ? ensurePagesLoaded() : Promise.resolve();
  
  loadPromise.then(() => {
    // Aggressive retry: 40 attempts over 4s (covers all mobile/desktop)
    let attempts = 0;
    function tryScroll() {
      attempts++;
      window.scrollTo(0, targetScroll);
      
      if (Math.abs(window.scrollY - targetScroll) <= 15 || attempts >= 40) {
        // Success: clear data + cleanup
        sessionStorage.removeItem('jobListScrollPosition');
        sessionStorage.removeItem('jobListCurrentPage');
        window.removeEventListener('beforeunload', disableBFCache);
        document.documentElement.style.scrollBehavior = 'smooth';
        isRestoring = false;
        return;
      }
      
      // Fast retries first, then slower (mobile paint cycles)
      const delay = attempts < 10 ? 30 : Math.min(100 + (attempts * 10), 300);
      setTimeout(() => requestAnimationFrame(tryScroll), delay);
    }
    
    // Double initial delay for mobile layout
    setTimeout(() => requestAnimationFrame(tryScroll), 500);
  }).catch(err => {
    console.error('Restore failed:', err);
    isRestoring = false;
  });
}

// Events: Comprehensive coverage
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', checkAndRestoreScroll);
} else {
  checkAndRestoreScroll();
}
window.addEventListener('pageshow', checkAndRestoreScroll);
window.addEventListener('load', checkAndRestoreScroll);


window.addEventListener('scroll', () => {
      const scrollTop = window.scrollY;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      if (scrollTop + windowHeight >= documentHeight - 300) {
        loadMoreJobs();
      }
    });

    // Initial bind for jobs rendered on first page load
    bindNormalJobClicks(container);

  </script>

  <style>
    .top-salary-swiper .swiper-wrapper { display: flex; align-items: stretch; }
    .top-salary-swiper .swiper-slide { height: auto; display: flex; }
    .top-salary-swiper .swiper-slide > article { width: 100%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const el = document.querySelector('.top-salary-swiper');
      if (!el || typeof Swiper === 'undefined') return;

      const savedSlideIndex = sessionStorage.getItem('topSalarySliderIndex');
      const initialSlide = savedSlideIndex ? parseInt(savedSlideIndex, 10) : 0;

      const swiper = new Swiper(el, {
        slidesPerView: 1.1,
        spaceBetween: 12,
        centeredSlides: false,
        loop: false,
        autoHeight: false,
        initialSlide: initialSlide,
        navigation: { nextEl: '.top-salary-next', prevEl: '.top-salary-prev' },
        breakpoints: {
          640: { slidesPerView: 3.2, spaceBetween: 16 },
          1024: { slidesPerView: 4.2, spaceBetween: 16 },
        },
        on: {
          slideChange: function () {
            sessionStorage.setItem('topSalarySliderIndex', this.activeIndex.toString());
          },
        },
      });

      const jobCards = el.querySelectorAll('.swiper-slide a');
      jobCards.forEach(function (card) {
        card.addEventListener('click', function () {
          sessionStorage.setItem('topSalarySliderIndex', swiper.activeIndex.toString());
          // Also save scroll position for top salary jobs
          sessionStorage.setItem('jobListScrollPosition', window.scrollY.toString());
          sessionStorage.setItem('jobListCurrentPage', document.getElementById('jobs-area').dataset.currentPage);
          
          try {
            if (window.amplitude) {
              const categoryId = this.getAttribute('data-job-category');
              window.amplitude.track('Highest Paid Job Clicked', {
                job_id: this.getAttribute('data-job-id'),
                job_category: categoryNames[categoryId] || categoryId,
                job_title: this.getAttribute('data-job-title'),
                salary_range: this.getAttribute('data-salary-range'),
                title: this.getAttribute('data-job-title'),
                company: this.getAttribute('data-job-company'),
                location: this.getAttribute('data-job-location')
              });
            }
          } catch (e) {}
        });
      });
    });
  </script>
</body>

</html>