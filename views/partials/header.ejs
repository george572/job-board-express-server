<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5NY4ZR4ZZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-5NY4ZR4ZZX');
</script>
<div id="site-header" class="sticky top-0 z-50 w-full bg-gradient-to-r from-[#FAFAFA] to-[#FFFFFF] border border-gray-200 rounded-lg">
  <header class="h-[60px] md:h-[112px] mx-auto p-4 flex justify-between items-center">
    <div class="flex items-center">
      <a href="/" class="cursor-pointer pr-2">
        <img src="/images/logo.svg" alt="Samushao.ge — ვაკანსიები საქართველოში" class="w-[150px] my-2" />
      </a>
    </div>
    <div class="flex items-center gap-4 relative">
      <div class="hidden sm:block font-[500] text-[#6B7280]">
        <a href="/terms-of-use" class=" block"> გამოყენების წესები </a>
      </div>
      <div class="flex items-center gap-4 relative">
        <div class="hidden sm:block font-[500] text-[#6B7280]">
          <a href="/pricing">ფასები</a>
        </div>
        <% if (!user) { %>
        <!-- Your custom button -->
        <button id="headerGoogleLoginBtn" class="border text-[14px] p-2 rounded-xl bg-[#2563eb] text-white cursor-pointer"> ავტორიზაცია
        </button>
        <% } else { %>
        <% if (user && user.user_type === 'company') { %>
        <a href="/add-new-job" class="flex w-[48px] lg:w-[217px] justify-center rounded-full items-center text-[12px] p-3 bg-[#F5F8FF] text-primary cursor-pointer font-medium">
          <%- include('./icons/plus.ejs') %>
          <span class="hidden lg:flex">ვაკანსიის დამატება</span>
        </a>
        <% } %>
        <div class="min-w-[48px] min-h-[48px] cursor-pointer bg-[#F5F8FF] rounded-full text-white uppercase flex items-center justify-center" onclick="event.stopPropagation();document.getElementById('logoutPopup').classList.toggle('hidden')">
          <%- include('./icons/user.ejs') %>
        </div>

        <% } %>
        
        <!-- Burger Toggle -->
        <div class="relative w-[28px] h-[30px] cursor-pointer block sm:hidden z-50" id="burgerToggle">
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 4px;"></span>
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 12px; opacity: 1;"></span>
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 20px;"></span>
        </div>
      </div>
      
      <!-- Responsive Navbar (hidden by default) -->
      <div id="responsiveNav" class="fixed top-[62px] md:top-[128px] right-0 w-1/2 h-screen bg-white border-l border-gray-200 z-40 p-4 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col gap-4">
          <a href="/pricing" class="block font-[500] text-[#6B7280]">ფასები</a>
          <a href="/terms-of-use" class="block font-[500] text-[#6B7280]">გამოყენების წესები</a>
        </div>
      </div>
    </div>

    <!-- Profile dropdown (hidden by default) -->
    <div id="logoutPopup" class="hidden fixed right-5 top-12 md:top-20 z-50 items-center justify-center">
      <div class="bg-white rounded-lg p-4 max-w-sm w-full mx-4 relative shadow-lg border border-gray-100">
        <% if (user && user.user_type === 'user') { %>
        <a href="/my-cv" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-[#F5F8FF] text-[#151515] no-underline w-full mb-2">
          <%- include('./icons/document-check.ejs') %>
          <span>ჩემი CV</span>
        </a>
        <a href="/my-applications" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-[#F5F8FF] text-[#151515] no-underline w-full mb-2">
          <%- include('./icons/document-check.ejs') %>
          <span>გაგზავნილი CV-ები</span>
        </a>
        <% } %>
        <form action="/logout" method="POST">
          <button type="submit" class="bg-red-500 cursor-pointer text-white px-4 py-2 rounded-lg w-full hover:bg-red-600">
            გასვლა
          </button>
        </form>
      </div>
    </div>
  </header>
</div>

<% if (typeof user === 'undefined' || !user) { %>
  <%- include('noCvBanner') %>
<% } %>
<style>
  #burgerToggle.active .burger-line:nth-child(1) {
    transform: rotate(45deg) translateY(12px);
  }
  #burgerToggle.active .burger-line:nth-child(2) {
    display: none;
  }
  #burgerToggle.active .burger-line:nth-child(3) {
    transform: rotate(-45deg) translateY(-12px);
  }

  /* Compact header-on-scroll */
  #site-header {
    --site-header-height: 60px;
    --site-header-padding-y: 1rem;
    --site-header-padding-x: 1rem;
    --site-header-nav-top: 62px;
    transition: box-shadow 200ms ease, border-color 200ms ease;
  }

  @media (min-width: 768px) {
    #site-header {
      --site-header-height: 112px;
      --site-header-nav-top: 128px;
    }
  }

  #site-header.is-compact {
    --site-header-height: 60px;
    --site-header-padding-y: 0.5rem;
    --site-header-nav-top: 64px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
  }

  @media (min-width: 768px) {
    #site-header.is-compact {
      --site-header-height: 60px;
      --site-header-padding-y: 0.5rem;
      --site-header-nav-top: 64px;
    }
  }

  /* Expose header height for filters (exactly below header) */
  body {
    --site-header-height: 60px;
  }
  @media (min-width: 768px) {
    body {
      --site-header-height: 112px;
    }
  }

  #site-header > header {
    height: var(--site-header-height);
    padding: var(--site-header-padding-y) var(--site-header-padding-x);
    transition: height 200ms ease, padding 200ms ease;
    will-change: height, padding;
  }

  #site-header a[href="/"] img {
    transition: width 200ms ease, transform 200ms ease, margin 200ms ease;
    will-change: width, transform;
  }

  #site-header.is-compact a[href="/"] img {
    width: 132px;
    margin-block: 0;
  }

  #site-header #responsiveNav {
    top: var(--site-header-nav-top);
    transition: top 200ms ease, transform 300ms ease;
  }
</style>
<script>
  function initHeader() {
    var burgerToggle = document.getElementById('burgerToggle');
    var responsiveNav = document.getElementById('responsiveNav');
    if (burgerToggle && responsiveNav) {
      burgerToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        responsiveNav.classList.toggle('translate-x-full');
        burgerToggle.classList.toggle('active');
      });
      document.addEventListener('click', function(e) {
        if (!responsiveNav.classList.contains('translate-x-full') &&
            !responsiveNav.contains(e.target) &&
            !burgerToggle.contains(e.target)) {
          responsiveNav.classList.add('translate-x-full');
          burgerToggle.classList.remove('active');
        }
      });
    }

    var loginBtn = document.getElementById('headerGoogleLoginBtn');
    if (loginBtn) {
      loginBtn.onclick = function() {
        var client = google.accounts.oauth2.initTokenClient({
          client_id: "1057690677446-ld6vggfgc9bgj6rc56sdddoqvl9ro4qk.apps.googleusercontent.com",
          scope: 'email profile openid',
          callback: function(response) {
            fetch('/api/auth/google', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ access_token: response.access_token })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
              if (data.success) window.location.reload();
            })
            .catch(function(err) { console.error("Auth Error:", err); });
          }
        });
        client.requestAccessToken();
      };
    }

    // Compact header on scroll (animate down + restore at top)
    var siteHeader = document.getElementById('site-header');
    if (siteHeader) {
      var lastCompact = null;
      var ticking = false;

      function updateHeaderCompact() {
        ticking = false;
        var shouldCompact = window.scrollY > 8;
        if (shouldCompact === lastCompact) return;
        siteHeader.classList.toggle('is-compact', shouldCompact);
        lastCompact = shouldCompact;
      }

      function onScroll() {
        if (ticking) return;
        ticking = true;
        window.requestAnimationFrame(updateHeaderCompact);
      }

      function syncHeaderHeightToBody() {
        var h = getComputedStyle(siteHeader).getPropertyValue('--site-header-height').trim();
        if (h) document.body.style.setProperty('--site-header-height', h);
      }
      syncHeaderHeightToBody();
      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('pageshow', function() {
        updateHeaderCompact();
        syncHeaderHeightToBody();
      });
      updateHeaderCompact();
      /* Keep body var in sync when compact toggles (for filters bar) */
      var observer = new MutationObserver(syncHeaderHeightToBody);
      observer.observe(siteHeader, { attributes: true, attributeFilter: ['class'] });
    }
  }

  document.addEventListener('click', function(e) {
    var popup = document.getElementById('logoutPopup');
    if (!popup) return;
    var popupContent = popup.querySelector('div');
    if (!popup.classList.contains('hidden') && popupContent && !popupContent.contains(e.target)) {
      popup.classList.add('hidden');
    }
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }
</script>
