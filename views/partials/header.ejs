<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5NY4ZR4ZZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-5NY4ZR4ZZX');
</script>
<div class="sticky top-0 z-50 w-full bg-gradient-to-r from-[#FAFAFA] to-[#FFFFFF] border border-gray-200 rounded-lg">
  <header class="h-[60px] md:h-[112px] mx-auto p-4 flex justify-between items-center">
    <div class="flex items-center">
      <a href="/" class="cursor-pointer pr-2">
        <img src="/images/logo.svg" alt="Samushao.ge — ვაკანსიები საქართველოში" class="w-[150px] my-2" />
      </a>
    </div>
    <div class="flex items-center gap-4 relative">
      <div class="hidden sm:block font-[300]">
        <a href="/terms-of-use" class=" block"> გამოყენების წესები </a>
      </div>
      <div class="flex items-center gap-4 relative font-mrgvlovani">
        <div class="hidden sm:block font-[300]">
          <a href="/pricing">ფასები</a>
        </div>
        <% if (!user) { %>
        <!-- Your custom button -->
        <button id="headerGoogleLoginBtn" class="border text-[14px] p-2 rounded-xl bg-[#2563eb] text-white cursor-pointer"> ავტორიზაცია
        </button>
        <% } else { %>
        <% if (user && user.user_type === 'company') { %>
        <a href="/add-new-job" class="flex w-[48px] lg:w-[217px] justify-center rounded-full items-center text-[12px] p-3 bg-[#F5F8FF] text-primary cursor-pointer font-medium">
          <%- include('./icons/plus.ejs') %>
          <span class="hidden lg:flex">ვაკანსიის დამატება</span>
        </a>
        <% } %>
        <div class="min-w-[48px] min-h-[48px] cursor-pointer bg-[#F5F8FF] rounded-full text-white uppercase flex items-center justify-center" onclick="event.stopPropagation();document.getElementById('logoutPopup').classList.toggle('hidden')">
          <%- include('./icons/user.ejs') %>
        </div>

        <% } %>
        
        <!-- Burger Toggle -->
        <div class="relative w-[28px] h-[30px] cursor-pointer block sm:hidden z-50" id="burgerToggle">
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 4px;"></span>
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 12px; opacity: 1;"></span>
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 20px;"></span>
        </div>
      </div>
      
      <!-- Responsive Navbar (hidden by default) -->
      <div id="responsiveNav" class="fixed top-[62px] md:top-[128px] right-0 w-1/2 h-screen bg-white border-l border-gray-200 z-40 p-4 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col gap-4">
          <a href="/pricing" class="block font-[300]">ფასები</a>
          <a href="/terms-of-use" class="block font-[300]">გამოყენების წესები</a>
        </div>
      </div>
    </div>

    <!-- Profile dropdown (hidden by default) -->
    <div id="logoutPopup" class="hidden fixed right-5 top-12 md:top-20 z-50 items-center justify-center">
      <div class="bg-white rounded-lg p-4 max-w-sm w-full mx-4 relative shadow-lg border border-gray-100">
        <% if (user && user.user_type === 'user') { %>
        <a href="/my-cv" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-[#F5F8FF] text-[#151515] no-underline w-full mb-2">
          <%- include('./icons/document-check.ejs') %>
          <span>ჩემი CV</span>
        </a>
        <a href="/my-applications" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-[#F5F8FF] text-[#151515] no-underline w-full mb-2">
          <%- include('./icons/document-check.ejs') %>
          <span>გაგზავნილი CV-ები</span>
        </a>
        <% } %>
        <form action="/logout" method="POST">
          <button type="submit" class="bg-red-500 cursor-pointer text-white px-4 py-2 rounded-lg w-full hover:bg-red-600">
            გასვლა
          </button>
        </form>
      </div>
    </div>
  </header>
</div>

<% if (typeof user === 'undefined' || !user) { %>
  <%- include('noCvBanner') %>
<% } %>
<style>
  #burgerToggle.active .burger-line:nth-child(1) {
    transform: rotate(45deg) translateY(12px);
  }
  #burgerToggle.active .burger-line:nth-child(2) {
    display: none;
  }
  #burgerToggle.active .burger-line:nth-child(3) {
    transform: rotate(-45deg) translateY(-12px);
  }
</style>
<script>
  // Burger toggle functionality - wait for DOM to load
  document.addEventListener('DOMContentLoaded', function() {
    const burgerToggle = document.getElementById('burgerToggle');
    const responsiveNav = document.getElementById('responsiveNav');

    if (burgerToggle && responsiveNav) {
      burgerToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        responsiveNav.classList.toggle('translate-x-full');
        burgerToggle.classList.toggle('active');
      });

      // Close navbar when clicking outside
      document.addEventListener('click', function(e) {
        if (!responsiveNav.classList.contains('translate-x-full') && 
            !responsiveNav.contains(e.target) && 
            !burgerToggle.contains(e.target)) {
          responsiveNav.classList.add('translate-x-full');
          burgerToggle.classList.remove('active');
        }
      });
    }
  });

  function handleCredentialResponse(response) {
    fetch('/api/auth/google', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          token: response.credential
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) window.location.reload();
      })
      .catch(err => console.error("Auth Error:", err));
  }
  window.onload = function() {
    const loginBtn = document.getElementById('headerGoogleLoginBtn');

    if (loginBtn) {
      loginBtn.onclick = () => {
        const client = google.accounts.oauth2.initTokenClient({
          client_id: "1057690677446-ld6vggfgc9bgj6rc56sdddoqvl9ro4qk.apps.googleusercontent.com",
          scope: 'email profile openid',
          callback: (response) => {
            // Send token to backend
            fetch('/api/auth/google', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  access_token: response.access_token
                })
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  window.location.reload(); // Reload to show logged-in state
                }
              })
              .catch(err => console.error("Auth Error:", err));
          }
        });

        // This opens the Google login popup
        client.requestAccessToken();
      };
    }
  };

  document.addEventListener('click', function(e) {
    const popup = document.getElementById('logoutPopup');
    const popupContent = popup?.querySelector('div'); // The actual small popup div

    // If popup is visible and click is outside the popup content
    if (!popup.classList.contains('hidden') && !popupContent.contains(e.target)) {
      popup.classList.add('hidden');
    }
  });

  // Job link interceptor: use cached job + fetch only description (no full reload)
  // Skip on touch devices – fetch+document.write+pushState breaks clicks after bfcache restore on mobile
  var isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // Hover prefetch: start fetching description before user clicks
  if (!isTouch) {
    window.__descPrefetch = window.__descPrefetch || {};
    document.addEventListener('mouseenter', function(e) {
      var link = e.target.closest('a.js-job-link[data-job-id]');
      if (!link) return;
      var jobId = link.getAttribute('data-job-id');
      if (!jobId || window.__descPrefetch[jobId]) return;
      window.__descPrefetch[jobId] = fetch('/api/jobs/' + jobId + '/description', { credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) { window.__descPrefetch[jobId] = d; return d; })
        .catch(function() { delete window.__descPrefetch[jobId]; });
    }, true);
  }

  document.addEventListener('click', function(e) {
    if (isTouch) return;
    var link = e.target.closest('a.js-job-link[href^="/vakansia/"][data-job-b64]');
    if (!link || e.ctrlKey || e.metaKey || e.shiftKey || e.button !== 0) return;
    e.preventDefault();
    var href = link.getAttribute('href');
    var pathOnly = href.split('?')[0];
    var jobB64 = link.getAttribute('data-job-b64');
    if (!jobB64) { window.location.href = href; return; }
    var job;
    try { job = JSON.parse(atob(jobB64)); } catch (err) { window.location.href = href; return; }
    if (!job || !job.id) { window.location.href = href; return; }
    fetch(pathOnly, {
      method: 'GET',
      credentials: 'same-origin',
      headers: { 'X-Cached-Job': jobB64 }
    }).then(function(r) {
      if (!r.ok) throw new Error(r.status);
      return r.text();
    }).then(function(html) {
      window.__docWriteNav = true;
      document.open();
      document.write(html);
      document.close();
      window.scrollTo(0, 0);
      window.history.pushState({}, '', pathOnly);
    }).catch(function() { window.location.href = href; });
  }, true);

  window.addEventListener('popstate', function() {
    if (window.__docWriteNav) {
      window.location.reload();
    }
  });

</script>
