<script src="https://accounts.google.com/gsi/client" async defer></script>
<div class="sticky top-0 z-50 w-full bg-gradient-to-r from-[#FAFAFA] to-[#FFFFFF] border border-gray-200 rounded-lg">
  <header class="h-[60px] md:h-[112px] mx-auto p-4 flex justify-between items-center">
    <div class="flex items-center">
      <a href="/" class="cursor-pointer pr-2">
        <img src="/images/logo.svg" alt="Samushao.ge — ვაკანსიები საქართველოში" class="w-[150px] my-2" />
      </a>
    </div>
    <div class="flex items-center gap-4 relative">
      <div class="hidden sm:block font-[300]">
        <a href="/privacy-policy" class=" block"> მონაცემთა დაცვის პოლიტიკა </a>
      </div>
      <div class="flex items-center gap-4 relative font-mrgvlovani">
        <div class="hidden sm:block font-[300]">
          <a href="/pricing">ფასები</a>
        </div>
        <% if (!user) { %>
        <!-- Your custom button -->
        <button id="headerGoogleLoginBtn" class="border text-[14px] p-2 rounded-xl bg-[#2563eb] text-white cursor-pointer"> ავტორიზაცია
        </button>
        <% } else { %>
        <% if (user && user.user_type === 'company') { %>
        <a href="/add-new-job" class="flex w-[48px] lg:w-[217px] justify-center rounded-full items-center text-[12px] p-3 bg-[#F5F8FF] text-primary cursor-pointer font-medium">
          <%- include('./icons/plus.ejs') %>
          <span class="hidden lg:flex">ვაკანსიის დამატება</span>
        </a>
        <% } %>
        <div class="min-w-[48px] min-h-[48px] cursor-pointer bg-[#F5F8FF] rounded-full text-white uppercase flex items-center justify-center" onclick="event.stopPropagation();document.getElementById('logoutPopup').classList.toggle('hidden')">
          <%- include('./icons/user.ejs') %>
        </div>

        <% } %>
        
        <!-- Burger Toggle -->
        <div class="relative w-[28px] h-[30px] cursor-pointer block sm:hidden z-50" id="burgerToggle">
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 4px;"></span>
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 12px; opacity: 1;"></span>
          <span class="burger-line absolute w-[28px] h-[2px] bg-black transition-all duration-300 ease-in-out" style="top: 20px;"></span>
        </div>
      </div>
      
      <!-- Responsive Navbar (hidden by default) -->
      <div id="responsiveNav" class="fixed top-[62px] md:top-[128px] right-0 w-1/2 h-screen bg-white border-l border-gray-200 z-40 p-4 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col gap-4">
          <a href="/pricing" class="block font-[300]">ფასები</a>
          <a href="/privacy-policy" class="block font-[300]">მონაცემთა დაცვის პოლიტიკა</a>
        </div>
      </div>
    </div>

    <!-- Profile dropdown (hidden by default) -->
    <div id="logoutPopup" class="hidden fixed right-5 top-12 md:top-20 z-50 items-center justify-center">
      <div class="bg-white rounded-lg p-4 max-w-sm w-full mx-4 relative shadow-lg border border-gray-100">
        <% if (user && user.user_type === 'user') { %>
        <a href="/my-applications" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-[#F5F8FF] text-[#151515] no-underline w-full mb-2">
          <%- include('./icons/document-check.ejs') %>
          <span>გაგზავნილი CV-ები</span>
        </a>
        <% } %>
        <form action="/logout" method="POST">
          <button type="submit" class="bg-red-500 cursor-pointer text-white px-4 py-2 rounded-lg w-full hover:bg-red-600">
            გასვლა
          </button>
        </form>
      </div>
    </div>
    <!-- user type modal: fixed overlay so it always appears on top (above filters/nav) -->
    <% if (user && user.user_type === 'pending') { %>
    <div class="user-type-modal-backdrop fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" aria-modal="true" role="dialog">
      <div class="user-type-modal flex flex-col max-w-[500px] w-full shadow-xl bg-white rounded-lg p-6 relative z-[101]">
        <div class="text-center font-medium">მომხმარებლის ტიპი</div>
        <div class="text-center text-sm my-2">რა ტიპის მომხმარებლის პროფილის შექმნა გსურთ?</div>
        <div>
          <div class="flex justify-center items-center my-4 flex-col gap-3">
            <label for="userTypeUser" class="flex items-center gap-2 cursor-pointer">
              <input type="radio" id="userTypeUser" name="userType" value="user">
              მომხმარებელი
            </label>
            <label for="userTypeCompany" class="flex items-center gap-2 cursor-pointer">
              <input type="radio" id="userTypeCompany" name="userType" value="company">
              კომპანია
            </label>
          </div>
        </div>
        <div class="flex justify-center gap-2">
          <button type="button" onclick="submitUserType()" class="border p-2 rounded-lg bg-green-600 text-white cursor-pointer font-[10px] block mt-4">
            დადასტურება
          </button>
        </div>
      </div>
    </div>
    <% } %>

  </header>
</div>
<style>
  #burgerToggle.active .burger-line:nth-child(1) {
    transform: rotate(45deg) translateY(12px);
  }
  #burgerToggle.active .burger-line:nth-child(2) {
    display: none;
  }
  #burgerToggle.active .burger-line:nth-child(3) {
    transform: rotate(-45deg) translateY(-12px);
  }
</style>
<script>
  // Burger toggle functionality - wait for DOM to load
  document.addEventListener('DOMContentLoaded', function() {
    const burgerToggle = document.getElementById('burgerToggle');
    const responsiveNav = document.getElementById('responsiveNav');

    if (burgerToggle && responsiveNav) {
      burgerToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        responsiveNav.classList.toggle('translate-x-full');
        burgerToggle.classList.toggle('active');
      });

      // Close navbar when clicking outside
      document.addEventListener('click', function(e) {
        if (!responsiveNav.classList.contains('translate-x-full') && 
            !responsiveNav.contains(e.target) && 
            !burgerToggle.contains(e.target)) {
          responsiveNav.classList.add('translate-x-full');
          burgerToggle.classList.remove('active');
        }
      });
    }
  });

  function handleCredentialResponse(response) {
    fetch('/api/auth/google', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          token: response.credential
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) window.location.reload();
      })
      .catch(err => console.error("Auth Error:", err));
  }
  window.onload = function() {
    const loginBtn = document.getElementById('headerGoogleLoginBtn');

    if (loginBtn) {
      loginBtn.onclick = () => {
        const client = google.accounts.oauth2.initTokenClient({
          client_id: "1057690677446-ld6vggfgc9bgj6rc56sdddoqvl9ro4qk.apps.googleusercontent.com",
          scope: 'email profile openid',
          callback: (response) => {
            // Send token to backend
            fetch('/api/auth/google', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  access_token: response.access_token
                })
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  window.location.reload(); // Reload to show logged-in state
                }
              })
              .catch(err => console.error("Auth Error:", err));
          }
        });

        // This opens the Google login popup
        client.requestAccessToken();
      };
    }
  };

  document.addEventListener('click', function(e) {
    const popup = document.getElementById('logoutPopup');
    const popupContent = popup?.querySelector('div'); // The actual small popup div

    // If popup is visible and click is outside the popup content
    if (!popup.classList.contains('hidden') && !popupContent.contains(e.target)) {
      popup.classList.add('hidden');
    }
  });

  function submitUserType() {
    const selectedType = document.querySelector('input[name="userType"]:checked');

    if (!selectedType) {
      return;
    }

    const userUid = '<%= user?.uid %>';

    fetch('/users/' + userUid, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          user_type: selectedType.value
        })
      })
      .then(res => res.json())
      .then(data => {
        // Update session to reflect new user_type
        return fetch('/api/user/update-session-type', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_type: selectedType.value
          })
        });
      })
      .then(() => {
        window.location.reload();
      })
      .catch(err => console.error("Error:", err));
  }
</script>