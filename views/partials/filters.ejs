<style>
  .filter-cb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid #cbd5e1;
    border-radius: 5px;
    flex-shrink: 0;
    position: relative;
    cursor: pointer;
    transition: all 0.15s ease;
    background: white;
  }
  .filter-cb:checked {
    background-color: #315EFF;
    border-color: #315EFF;
  }
  .filter-cb:checked::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 1px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }
  .filter-cb:hover {
    border-color: #315EFF;
  }
  .filter-cb:focus-visible {
    outline: 2px solid #315EFF;
    outline-offset: 2px;
  }
  .filter-ms-panel {
    display: none;
    position: absolute;
    left: 0;
    top: 100%;
    margin-top: 4px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.06);
    z-index: 50;
    min-width: 240px;
    max-height: 320px;
    overflow-y: auto;
    padding: 4px 0;
  }
  @media (max-width: 767px) {
    .filter-ms { width: 100%; }
    .filter-ms-panel {
      left: 0;
      right: 0;
      width: 100%;
      min-width: 0;
      max-height: 60vh;
    }
  }
  .filter-ms-panel.open {
    display: block;
    animation: filterPanelIn 0.15s ease-out;
  }
  @keyframes filterPanelIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .filter-ms-panel::-webkit-scrollbar {
    width: 6px;
  }
  .filter-ms-panel::-webkit-scrollbar-track {
    background: transparent;
  }
  .filter-ms-panel::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }
  @media (min-width: 768px) {
    #filtersSection {
      max-height: none !important;
      overflow: visible !important;
      display: flex;
      padding-bottom: 1rem;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
  }
</style>

<div
  class="filters-sticky-wrapper py-2 px-4 sticky z-10 bg-[#f8f9fa]"
  style="top: var(--site-header-height, 60px);"
>
  <!-- Mobile: search bar + ფილტრი button -->
  <div class="flex md:hidden items-center gap-2">
    <button
      type="button"
      id="filterToggleBtn"
      class="md:hidden shrink-0 flex items-center gap-1.5 px-4 py-2 h-[44px] rounded-lg border border-slate-200 bg-white text-xs font-medium text-[#151515] cursor-pointer hover:bg-[#F5F8FF]"
    >
      ფილტრი
      <svg
        id="filterToggleIcon"
        class="w-4 h-4 transition-transform duration-200"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="m19.5 8.25-7.5 7.5-7.5-7.5"
        ></path>
      </svg>
    </button>
    <div class="flex-1 relative">
      <input
        id="searchInput"
        placeholder="ძებნა"
        type="text"
        class="border-slate-200 bg-white w-full h-[44px] outline-none rounded-lg border p-3 font-[500] pr-10"
        autocomplete="off"
      />
      <button
        type="button"
        id="searchSubmitBtn"
        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 cursor-pointer text-gray-500 hover:text-[#315EFF] min-h-[36px] min-w-[36px] flex items-center justify-center"
        aria-label="ძებნა"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Filters section: collapsible on mobile, always visible on desktop -->
  <div
    id="filtersSection"
    class="transition-[max-height] duration-300 ease-in-out overflow-hidden"
    style="max-height: 0px"
    data-open="false"
  >
    <div class="flex flex-col md:flex-row md:flex-wrap gap-2 md:gap-1 pt-2 md:pt-0 flex-1 md:items-center">

      <!-- Category -->
      <div class="filter-ms relative" data-filter-key="category">
        <button type="button" class="filter-ms-trigger flex items-center justify-between gap-1.5 text-xs px-3 border border-slate-200 bg-white h-[44px] rounded-lg cursor-pointer w-full md:w-[172px] hover:bg-[#F5F8FF] transition-colors">
          <span class="filter-ms-label truncate text-[#151515]">კატეგორიები</span>
          <span class="filter-ms-badge hidden items-center justify-center bg-[#315EFF] text-white text-[11px] font-semibold rounded-full min-w-[20px] h-[20px] px-1.5">0</span>
          <svg class="filter-ms-chevron w-4 h-4 text-gray-400 transition-transform duration-200 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg>
        </button>
        <div class="filter-ms-panel">
          <%
          const filterCategories = [
            { id: 25, name: "ადმინისტრატორი" }, { id: 8, name: "აზარტული" }, { id: 20, name: "ბუღალტერია" },
            { id: 3, name: "გაყიდვები" }, { id: 18, name: "დიასახლისი" }, { id: 16, name: "დისტრიბუცია" },
            { id: 23, name: "ექთანი" }, { id: 24, name: "ექიმი" }, { id: 26, name: "HR" },
            { id: 12, name: "ინჟინერია" }, { id: 17, name: "ინფორმაციული ტექნოლოგიები" }, { id: 27, name: "იურიდიული" },
            { id: 13, name: "ლოჯისტიკა" }, { id: 9, name: "მენეჯმენტი" }, { id: 11, name: "მიმტანი" },
            { id: 7, name: "მზარეული" }, { id: 21, name: "მძღოლი" }, { id: 2, name: "მომხმარებელთან ურთიერთობები" },
            { id: 4, name: "საბანკო-საფინანსო" }, { id: 1, name: "საოფისე" }, { id: 6, name: "საცალო ვაჭრობა" },
            { id: 5, name: "საწყობი და წარმოება" }, { id: 14, name: "სამედიცინო" }, { id: 19, name: "სხვა" },
            { id: 15, name: "უსაფრთხოება" }, { id: 10, name: "ფარმაცია" }, { id: 22, name: "Web/Digital/Design" },
          ].sort((a, b) => (a.name.localeCompare ? a.name.localeCompare(b.name, 'ka') : (a.name < b.name ? -1 : 1)));
          filterCategories.forEach(cat => { %>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="<%= cat.id %>"/><span class="flex-1"><%= cat.name %></span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <% }); %>
        </div>
      </div>

      <!-- Salary -->
      <div class="filter-ms relative" data-filter-key="min_salary">
        <button type="button" class="filter-ms-trigger flex items-center justify-between gap-1.5 text-xs px-3 border border-slate-200 bg-white h-[44px] rounded-lg cursor-pointer w-full md:w-[172px] hover:bg-[#F5F8FF] transition-colors">
          <span class="filter-ms-label truncate text-[#151515]">ანაზღაურება</span>
          <span class="filter-ms-badge hidden items-center justify-center bg-[#315EFF] text-white text-[11px] font-semibold rounded-full min-w-[20px] h-[20px] px-1.5">0</span>
          <svg class="filter-ms-chevron w-4 h-4 text-gray-400 transition-transform duration-200 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg>
        </button>
        <div class="filter-ms-panel">
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="1000"/><span class="flex-1">1000 GEL +</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="2000"/><span class="flex-1">2000 GEL +</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="3000"/><span class="flex-1">3000 GEL +</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="4000"/><span class="flex-1">4000 GEL +</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="5000"/><span class="flex-1">5000 GEL +</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="6000"/><span class="flex-1">6000 GEL +</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
        </div>
      </div>

      <!-- Experience -->
      <div class="filter-ms relative" data-filter-key="job_experience">
        <button type="button" class="filter-ms-trigger flex items-center justify-between gap-1.5 text-xs px-3 border border-slate-200 bg-white h-[44px] rounded-lg cursor-pointer w-full md:w-[172px] hover:bg-[#F5F8FF] transition-colors">
          <span class="filter-ms-label truncate text-[#151515]">გამოცდილება</span>
          <span class="filter-ms-badge hidden items-center justify-center bg-[#315EFF] text-white text-[11px] font-semibold rounded-full min-w-[20px] h-[20px] px-1.5">0</span>
          <svg class="filter-ms-chevron w-4 h-4 text-gray-400 transition-transform duration-200 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg>
        </button>
        <div class="filter-ms-panel">
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="intern"/><span class="flex-1">სტაჟირება</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="0-1"/><span class="flex-1">0-1 წელი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="1-2"/><span class="flex-1">1-2 წელი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="3-5"/><span class="flex-1">3-5 წელი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="5+"/><span class="flex-1">5+ წელი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
        </div>
      </div>

      <!-- Job Type -->
      <div class="filter-ms relative" data-filter-key="job_type">
        <button type="button" class="filter-ms-trigger flex items-center justify-between gap-1.5 text-xs px-3 border border-slate-200 bg-white h-[44px] rounded-lg cursor-pointer w-full md:w-[172px] hover:bg-[#F5F8FF] transition-colors">
          <span class="filter-ms-label truncate text-[#151515]">განაკვეთი</span>
          <span class="filter-ms-badge hidden items-center justify-center bg-[#315EFF] text-white text-[11px] font-semibold rounded-full min-w-[20px] h-[20px] px-1.5">0</span>
          <svg class="filter-ms-chevron w-4 h-4 text-gray-400 transition-transform duration-200 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg>
        </button>
        <div class="filter-ms-panel">
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="full-time"/><span class="flex-1">სრული განაკვეთი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="part-time"/><span class="flex-1">ნახევარი განაკვეთი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
        </div>
      </div>

      <!-- Work Mode -->
      <div class="filter-ms relative" data-filter-key="work_mode">
        <button type="button" class="filter-ms-trigger flex items-center justify-between gap-1.5 text-xs px-3 border border-slate-200 bg-white h-[44px] rounded-lg cursor-pointer w-full md:w-[172px] hover:bg-[#F5F8FF] transition-colors">
          <span class="filter-ms-label truncate text-[#151515]">სამუშაო რეჟიმი</span>
          <span class="filter-ms-badge hidden items-center justify-center bg-[#315EFF] text-white text-[11px] font-semibold rounded-full min-w-[20px] h-[20px] px-1.5">0</span>
          <svg class="filter-ms-chevron w-4 h-4 text-gray-400 transition-transform duration-200 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg>
        </button>
        <div class="filter-ms-panel">
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ადგილზე"/><span class="flex-1">ადგილზე</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="დისტანციური"/><span class="flex-1">დისტანციური</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
        </div>
      </div>

      <!-- City -->
      <div class="filter-ms relative" data-filter-key="job_city">
        <button type="button" class="filter-ms-trigger flex items-center justify-between gap-1.5 text-xs px-3 border border-slate-200 bg-white h-[44px] rounded-lg cursor-pointer w-full md:w-[172px] hover:bg-[#F5F8FF] transition-colors">
          <span class="filter-ms-label truncate text-[#151515]">ქალაქი</span>
          <span class="filter-ms-badge hidden items-center justify-center bg-[#315EFF] text-white text-[11px] font-semibold rounded-full min-w-[20px] h-[20px] px-1.5">0</span>
          <svg class="filter-ms-chevron w-4 h-4 text-gray-400 transition-transform duration-200 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg>
        </button>
        <div class="filter-ms-panel">
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="თბილისი"/><span class="flex-1">თბილისი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ქუთაისი"/><span class="flex-1">ქუთაისი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ბათუმი"/><span class="flex-1">ბათუმი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ზუგდიდი"/><span class="flex-1">ზუგდიდი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="გორი"/><span class="flex-1">გორი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="რუსთავი"/><span class="flex-1">რუსთავი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="მცხეთა"/><span class="flex-1">მცხეთა</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="თელავი"/><span class="flex-1">თელავი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="მესტია"/><span class="flex-1">მესტია</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ფოთი"/><span class="flex-1">ფოთი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ჭიათურა"/><span class="flex-1">ჭიათურა</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="ზესტაფონი"/><span class="flex-1">ზესტაფონი</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
          <label class="flex items-center gap-4 px-3 h-[50px] hover:bg-[#F5F8FF] cursor-pointer text-xs"><input type="checkbox" class="filter-cb" value="მარნეული"/><span class="flex-1">მარნეული</span><span class="filter-item-count text-gray-400 text-[11px]"></span></label>
        </div>
      </div>

      <!-- Apply button -->
      <button
        type="button"
        id="submitFilterBtn"
        class="h-[44px] px-4 rounded-lg bg-[#315EFF] text-white text-sm font-medium cursor-pointer hover:bg-[#2849d9] shrink-0 w-full md:w-auto"
      >
        გაფილტრე
      </button>
    </div>

    <!-- Desktop search -->
    <div class="hidden md:flex relative max-w-[200px] items-center">
      <input
        id="searchInputDesktop"
        placeholder="ძებნა"
        type="text"
        class="border-slate-200 bg-white w-full h-[44px] outline-none rounded-lg border p-3 font-[500] pr-10"
        autocomplete="off"
      />
      <button
        type="button"
        id="searchSubmitBtnDesktop"
        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 cursor-pointer text-gray-500 hover:text-[#315EFF] min-h-[36px] min-w-[36px] flex items-center justify-center"
        aria-label="ძებნა"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Active Filter Tags -->
<div
  id="activeFiltersContainer"
  class="px-4 pb-2 flex flex-col gap-2 md:flex-row md:flex-wrap md:items-center"
  style="display: none"
>
  <div id="activeFiltersList" class="flex flex-wrap gap-2 md:flex-1"></div>
  <button
    id="clearAllFiltersBtn"
    type="button"
    class="text-xs text-gray-600 underline cursor-pointer whitespace-nowrap w-full md:w-auto text-left md:text-left"
  >
    ყველა ფილტრის წაშლა
  </button>
</div>

<script>
  (function () {
    var categoryNames = {
      1: "საოფისე", 2: "მომხმარებელთან ურთიერთობები", 3: "გაყიდვები",
      4: "საბანკო-საფინანსო", 5: "საწყობი და წარმოება", 6: "საცალო ვაჭრობა",
      7: "მზარეული", 8: "აზარტული", 9: "მენეჯმენტი", 10: "ფარმაცია",
      11: "მიმტანი", 12: "ინჟინერია", 13: "ლოჯისტიკა", 14: "სამედიცინო",
      15: "უსაფრთხოება", 16: "დისტრიბუცია", 17: "ინფორმაციული ტექნოლოგიები",
      18: "დიასახლისი", 19: "სხვა", 20: "ბუღალტერია", 21: "მძღოლი",
      22: "Web/Digital/Design", 23: "ექთანი", 24: "ექიმი",
      25: "ადმინისტრატორი", 26: "HR", 27: "იურიდიული",
    };
    var experienceNames = { intern: "სტაჟირება", "0-1": "0-1 წელი", "1-2": "1-2 წელი", "3-5": "3-5 წელი", "5+": "5+ წელი" };
    var jobTypeNames = { "full-time": "სრული განაკვეთი", "part-time": "ნახევარი განაკვეთი" };
    var workModeNames = { "ადგილზე": "ადგილზე", "დისტანციური": "დისტანციური" };
    var cityNames = { "თბილისი": "თბილისი", "ქუთაისი": "ქუთაისი", "ბათუმი": "ბათუმი", "ზუგდიდი": "ზუგდიდი", "გორი": "გორი", "რუსთავი": "რუსთავი", "მცხეთა": "მცხეთა", "თელავი": "თელავი", "მესტია": "მესტია", "ფოთი": "ფოთი", "ჭიათურა": "ჭიათურა", "ზესტაფონი": "ზესტაფონი", "მარნეული": "მარნეული" };
    var salaryNames = { 1000: "1000 GEL +", 2000: "2000 GEL +", 3000: "3000 GEL +", 4000: "4000 GEL +", 5000: "5000 GEL +", 6000: "6000 GEL +" };

    var defaultLabels = {
      category: "კატეგორიები", min_salary: "ანაზღაურება", job_experience: "გამოცდილება",
      job_type: "განაკვეთი", work_mode: "სამუშაო რეჟიმი", job_city: "ქალაქი",
    };
    var namesMaps = {
      category: categoryNames, min_salary: salaryNames, job_experience: experienceNames,
      job_type: jobTypeNames, work_mode: workModeNames, job_city: cityNames,
    };
    var filterKeys = ["category", "min_salary", "job_experience", "job_type", "work_mode", "job_city"];

    var searchInput = document.getElementById("searchInput");
    var searchInputDesktop = document.getElementById("searchInputDesktop");
    var searchSubmitBtn = document.getElementById("searchSubmitBtn");
    var searchSubmitBtnDesktop = document.getElementById("searchSubmitBtnDesktop");
    var activeFiltersContainer = document.getElementById("activeFiltersContainer");
    var activeFiltersList = document.getElementById("activeFiltersList");
    var clearAllFiltersBtn = document.getElementById("clearAllFiltersBtn");
    var filtersSection = document.getElementById("filtersSection");
    var filterCountsCache = {};

    // ── Panel management ──
    function closeAllPanels() {
      document.querySelectorAll(".filter-ms-panel.open").forEach(function (p) { p.classList.remove("open"); });
      document.querySelectorAll(".filter-ms-chevron").forEach(function (c) { c.style.transform = ""; });
    }

    function togglePanel(filterKey) {
      var wrapper = document.querySelector('.filter-ms[data-filter-key="' + filterKey + '"]');
      if (!wrapper) return;
      var panel = wrapper.querySelector(".filter-ms-panel");
      var chevron = wrapper.querySelector(".filter-ms-chevron");
      var isOpen = panel.classList.contains("open");
      closeAllPanels();
      if (!isOpen) {
        panel.classList.add("open");
        if (chevron) chevron.style.transform = "rotate(180deg)";
        ensureFilterCountsLoaded();
      }
    }

    document.addEventListener("click", function (e) {
      if (!e.target.closest(".filter-ms")) closeAllPanels();
    });

    document.querySelectorAll(".filter-ms-trigger").forEach(function (trigger) {
      trigger.addEventListener("click", function (e) {
        e.stopPropagation();
        var key = this.closest(".filter-ms").dataset.filterKey;
        togglePanel(key);
      });
    });

    // Prevent panel clicks from closing the panel
    document.querySelectorAll(".filter-ms-panel").forEach(function (panel) {
      panel.addEventListener("click", function (e) { e.stopPropagation(); });
    });

    // ── Selected values ──
    function getSelectedValues(key) {
      var wrapper = document.querySelector('.filter-ms[data-filter-key="' + key + '"]');
      if (!wrapper) return [];
      var checked = wrapper.querySelectorAll('.filter-ms-panel input[type="checkbox"]:checked');
      return Array.from(checked).map(function (cb) { return cb.value; });
    }

    function getFiltersFromUI() {
      var qEl = window.innerWidth < 768 ? searchInput : (searchInputDesktop || searchInput);
      var filters = { q: qEl ? qEl.value.trim() : "" };
      filterKeys.forEach(function (key) { filters[key] = getSelectedValues(key); });
      return filters;
    }

    // ── Trigger label updates ──
    function updateTriggerLabel(key) {
      var wrapper = document.querySelector('.filter-ms[data-filter-key="' + key + '"]');
      if (!wrapper) return;
      var label = wrapper.querySelector(".filter-ms-label");
      var badge = wrapper.querySelector(".filter-ms-badge");
      var count = getSelectedValues(key).length;
      if (label) label.textContent = defaultLabels[key] || key;
      if (badge) {
        badge.textContent = count;
        if (count > 0) {
          badge.classList.remove("hidden");
          badge.classList.add("flex");
        } else {
          badge.classList.add("hidden");
          badge.classList.remove("flex");
        }
      }
    }

    function updateAllTriggerLabels() {
      filterKeys.forEach(updateTriggerLabel);
    }

    // ── Checkbox change handler ──
    document.querySelectorAll('.filter-ms input[type="checkbox"]').forEach(function (cb) {
      cb.addEventListener("change", function () {
        var key = this.closest(".filter-ms").dataset.filterKey;
        updateTriggerLabel(key);
        debouncedEnsureFilterCounts();
      });
    });

    // ── URL params ──
    function getUrlParams() {
      var params = new URLSearchParams(window.location.search);
      return {
        category: params.getAll("category"),
        min_salary: params.getAll("min_salary"),
        job_experience: params.getAll("job_experience"),
        job_type: params.getAll("job_type"),
        work_mode: params.getAll("work_mode"),
        job_city: params.getAll("job_city"),
        q: params.get("q") || "",
      };
    }

    function hasActiveFilters() {
      var p = getUrlParams();
      return filterKeys.some(function (k) { return p[k] && p[k].length > 0; }) || (p.q && p.q.trim() !== "");
    }

    // ── Set checkboxes from URL ──
    function setFiltersFromUrl() {
      var params = getUrlParams();
      filterKeys.forEach(function (key) {
        var values = params[key] || [];
        var wrapper = document.querySelector('.filter-ms[data-filter-key="' + key + '"]');
        if (!wrapper) return;
        wrapper.querySelectorAll('.filter-ms-panel input[type="checkbox"]').forEach(function (cb) {
          cb.checked = values.indexOf(cb.value) !== -1;
        });
      });
      [searchInput, searchInputDesktop].forEach(function (s) { if (s) s.value = params.q || ""; });
      updateAllTriggerLabels();
    }

    // ── Build URL ──
    function buildUrlFromFilters(filters) {
      var params = new URLSearchParams();
      filterKeys.forEach(function (key) {
        if (filters[key] && filters[key].length > 0) {
          filters[key].forEach(function (v) { params.append(key, v); });
        }
      });
      if (filters.q && filters.q.trim()) params.set("q", filters.q.trim());
      return params.toString() ? "/?" + params.toString() : "/";
    }

    // ── Filter counts ──
    function applyFilterCountsToItems(data) {
      filterKeys.forEach(function (key) {
        var counts = (data && data[key]) ? data[key] : {};
        var wrapper = document.querySelector('.filter-ms[data-filter-key="' + key + '"]');
        if (!wrapper) return;
        wrapper.querySelectorAll('.filter-ms-panel input[type="checkbox"]').forEach(function (cb) {
          var countSpan = cb.closest("label").querySelector(".filter-item-count");
          if (!countSpan) return;
          var c = counts[cb.value];
          countSpan.textContent = c !== undefined ? c : "";
        });
      });
    }

    function ensureFilterCountsLoaded() {
      var params = getFiltersFromUI();
      var qs = new URLSearchParams();
      filterKeys.forEach(function (key) {
        if (params[key] && params[key].length > 0) {
          params[key].forEach(function (v) { qs.append(key, v); });
        }
      });
      if (params.q && params.q.trim()) qs.set("q", params.q.trim());
      var cacheKey = qs.toString() || "base";
      if (filterCountsCache[cacheKey]) {
        applyFilterCountsToItems(filterCountsCache[cacheKey]);
        return;
      }
      var fetchUrl = qs.toString() ? "/api/filter-counts?" + qs.toString() : "/api/filter-counts";
      fetch(fetchUrl)
        .then(function (res) { return res.json(); })
        .then(function (data) {
          filterCountsCache[cacheKey] = data;
          applyFilterCountsToItems(data);
        })
        .catch(function () {});
    }

    var filterCountsDebounce = null;
    function debouncedEnsureFilterCounts() {
      if (filterCountsDebounce) clearTimeout(filterCountsDebounce);
      filterCountsDebounce = setTimeout(function () {
        filterCountsDebounce = null;
        ensureFilterCountsLoaded();
      }, 200);
    }

    // ── Visibility toggles ──
    function updateTopSalarySliderVisibility() {
      var hide = hasActiveFilters();
      var ids = [
        "recommended-jobs-section", "facebook-promo-main", "top-salary-slider-section",
        "top-popular-slider-section", "form-submission-slider-section",
        "top-cv-fit-slider-section", "today-jobs-section", "all-vacancies-heading",
      ];
      ids.forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.style.display = hide ? "none" : "";
      });
    }

    function setJobsLoading(isLoading) {
      var loadingEl = document.getElementById("loading-indicator");
      if (loadingEl) loadingEl.style.display = isLoading ? "block" : "none";
    }

    // ── Update URL (fetch + pushState) ──
    function updateUrl(filters) {
      var newUrl = buildUrlFromFilters(filters);
      setJobsLoading(true);
      fetch(newUrl, { headers: { Accept: "text/html" } })
        .then(function (res) { return res.text(); })
        .then(function (html) {
          var parser = new DOMParser();
          var doc = parser.parseFromString(html, "text/html");
          var fetchedJobsArea = doc.getElementById("jobs-area");
          var currentJobsArea = document.getElementById("jobs-area");
          if (fetchedJobsArea && currentJobsArea) {
            currentJobsArea.innerHTML = fetchedJobsArea.innerHTML;
            currentJobsArea.dataset.currentPage = fetchedJobsArea.dataset.currentPage || "1";
            currentJobsArea.dataset.totalPages = fetchedJobsArea.dataset.totalPages || "1";
            if (localStorage.getItem("enlisted_fb")) {
              currentJobsArea.querySelectorAll("[data-fb-promo]").forEach(function (el) { el.style.display = "none"; });
            }
          }
          history.pushState({ filters: filters }, "", newUrl);
          setFiltersFromUrl();
          renderActiveFilters();
          ensureFilterCountsLoaded();
          updateTopSalarySliderVisibility();
          window.scrollTo(0, 0);
          setJobsLoading(false);
        })
        .catch(function (err) {
          console.error("Filter fetch error:", err);
          setJobsLoading(false);
          window.location.href = newUrl;
        });
    }

    // ── Active filter tags ──
    function getFilterDisplayName(type, value) {
      if (type === "q") return "ძებნა: " + value;
      var map = namesMaps[type];
      return map ? (map[value] || value) : value;
    }

    function renderActiveFilters() {
      var params = getUrlParams();
      activeFiltersList.innerHTML = "";
      var hasFilters = false;
      filterKeys.forEach(function (key) {
        var values = params[key] || [];
        values.forEach(function (val) {
          hasFilters = true;
          activeFiltersList.appendChild(createFilterTag(key, val, getFilterDisplayName(key, val)));
        });
      });
      if (params.q && params.q.trim()) {
        hasFilters = true;
        activeFiltersList.appendChild(createFilterTag("q", params.q.trim(), getFilterDisplayName("q", params.q.trim())));
      }
      activeFiltersContainer.style.display = hasFilters ? "flex" : "none";
    }

    function createFilterTag(type, value, displayName) {
      var tag = document.createElement("div");
      tag.className = "flex items-center gap-1 bg-[#315EFF] text-white text-xs px-3 py-1 rounded-full";
      var escapedDisplay = displayName.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
      var escapedValue = (value + "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
      tag.innerHTML =
        '<span>' + escapedDisplay + '</span>' +
        '<button type="button" class="ml-1 cursor-pointer hover:opacity-80" data-filter-type="' + type + '" data-filter-value="' + escapedValue + '">' +
          '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">' +
            '<path d="M9 3L3 9M3 3L9 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>' +
          '</svg>' +
        '</button>';
      var removeBtn = tag.querySelector("button");
      removeBtn.addEventListener("click", function () { removeFilter(type, value); });
      return tag;
    }

    // ── Remove a specific filter value ──
    function removeFilter(type, value) {
      var params = getUrlParams();
      if (type === "q") {
        params.q = "";
        [searchInput, searchInputDesktop].forEach(function (s) { if (s) s.value = ""; });
      } else {
        params[type] = (params[type] || []).filter(function (v) { return v !== String(value); });
        var wrapper = document.querySelector('.filter-ms[data-filter-key="' + type + '"]');
        if (wrapper) {
          wrapper.querySelectorAll('.filter-ms-panel input[type="checkbox"]').forEach(function (cb) {
            if (cb.value === String(value)) cb.checked = false;
          });
        }
      }
      updateAllTriggerLabels();
      updateUrl(params);
    }

    // ── Clear all filters ──
    function clearAllFilters() {
      document.querySelectorAll('.filter-ms input[type="checkbox"]').forEach(function (cb) { cb.checked = false; });
      [searchInput, searchInputDesktop].forEach(function (s) { if (s) s.value = ""; });
      updateAllTriggerLabels();
      var empty = { q: "" };
      filterKeys.forEach(function (k) { empty[k] = []; });
      updateUrl(empty);
    }

    // ── Apply filters button ──
    function applyFiltersFromButton() {
      var params = getFiltersFromUI();
      closeAllPanels();
      updateUrl(params);
      if (window.innerWidth < 768 && filtersSection && filtersSection.dataset.open === "true") {
        filtersSection.style.overflow = "hidden";
        filtersSection.style.maxHeight = "0px";
        filtersSection.dataset.open = "false";
        var icon = document.getElementById("filterToggleIcon");
        if (icon) icon.style.transform = "rotate(0deg)";
      }
    }

    // ── Search handlers ──
    function applySearch() {
      if (searchInput && searchInputDesktop) {
        if (window.innerWidth >= 768) searchInput.value = searchInputDesktop.value;
        else searchInputDesktop.value = searchInput.value;
      }
      applyFiltersFromButton();
    }

    if (searchInput) {
      searchInput.addEventListener("keydown", function (e) { if (e.key === "Enter") { e.preventDefault(); applySearch(); } });
      searchInput.addEventListener("input", function () { if (searchInputDesktop) searchInputDesktop.value = this.value; });
    }
    if (searchInputDesktop) {
      searchInputDesktop.addEventListener("keydown", function (e) { if (e.key === "Enter") { e.preventDefault(); applySearch(); } });
      searchInputDesktop.addEventListener("input", function () { if (searchInput) searchInput.value = this.value; });
    }
    if (searchSubmitBtn) searchSubmitBtn.addEventListener("click", applySearch);
    if (searchSubmitBtnDesktop) searchSubmitBtnDesktop.addEventListener("click", applySearch);

    // ── Submit & clear buttons ──
    var submitFilterBtn = document.getElementById("submitFilterBtn");
    if (submitFilterBtn) submitFilterBtn.addEventListener("click", applyFiltersFromButton);
    if (clearAllFiltersBtn) clearAllFiltersBtn.addEventListener("click", clearAllFilters);

    // ── Mobile toggle ──
    var filterToggleBtn = document.getElementById("filterToggleBtn");
    var filterToggleIcon = document.getElementById("filterToggleIcon");
    if (filterToggleBtn && filtersSection) {
      filterToggleBtn.addEventListener("click", function () {
        var isOpen = filtersSection.dataset.open === "true";
        if (isOpen) {
          closeAllPanels();
          filtersSection.style.overflow = "hidden";
          filtersSection.style.maxHeight = "0px";
          filtersSection.dataset.open = "false";
          if (filterToggleIcon) filterToggleIcon.style.transform = "rotate(0deg)";
        } else {
          filtersSection.style.overflow = "hidden";
          filtersSection.style.maxHeight = "9999px";
          var h = filtersSection.scrollHeight;
          filtersSection.style.maxHeight = "0px";
          filtersSection.offsetHeight;
          filtersSection.style.maxHeight = h + "px";
          filtersSection.dataset.open = "true";
          if (filterToggleIcon) filterToggleIcon.style.transform = "rotate(180deg)";
          setTimeout(function () {
            if (filtersSection.dataset.open === "true") filtersSection.style.overflow = "visible";
          }, 310);
          ensureFilterCountsLoaded();
        }
      });
    }

    // ── Back/forward (popstate) ──
    window.addEventListener("popstate", function () {
      if (sessionStorage.getItem("jobListScrollPosition")) return;
      var url = window.location.pathname + (window.location.search || "");
      fetch(url, { headers: { Accept: "text/html" } })
        .then(function (res) { return res.text(); })
        .then(function (html) {
          var parser = new DOMParser();
          var doc = parser.parseFromString(html, "text/html");
          var fetchedJobsArea = doc.getElementById("jobs-area");
          var currentJobsArea = document.getElementById("jobs-area");
          if (fetchedJobsArea && currentJobsArea) {
            currentJobsArea.innerHTML = fetchedJobsArea.innerHTML;
            currentJobsArea.dataset.currentPage = fetchedJobsArea.dataset.currentPage || "1";
            currentJobsArea.dataset.totalPages = fetchedJobsArea.dataset.totalPages || "1";
            if (localStorage.getItem("enlisted_fb")) {
              currentJobsArea.querySelectorAll("[data-fb-promo]").forEach(function (el) { el.style.display = "none"; });
            }
          }
          setFiltersFromUrl();
          renderActiveFilters();
          ensureFilterCountsLoaded();
          updateTopSalarySliderVisibility();
          window.scrollTo(0, 0);
        })
        .catch(function () { window.location.reload(); });
    });

    // ── Init ──
    setFiltersFromUrl();
    renderActiveFilters();
    updateTopSalarySliderVisibility();
    ensureFilterCountsLoaded();
  })();
</script>
