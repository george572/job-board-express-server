<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <%- include('partials/head-meta', { seo }) %>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="preload" href="/fonts/NotoSansGeorgian-georgian.woff2" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face {
      font-family: 'Noto Sans Georgian PDF';
      font-style: normal;
      font-weight: 400 700;
      font-display: swap;
      src: url('/fonts/NotoSansGeorgian-georgian.woff2') format('woff2');
      unicode-range: U+0589, U+10A0-10FF, U+1C90-1CBA, U+1CBD-1CBF, U+205A, U+2D00-2D2F, U+2E31;
    }
    .sheqmeni-page {
      height: 80vh;
      background-color: #F8F9FA;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sheqmeni-main {
      flex: 1;
      min-height: 0;
      display: flex;
      align-items: stretch;
      justify-content: flex-start;
      padding: 1rem;
      gap: 1rem;
    }
    .sheqmeni-preview {
      flex: 1;
      min-width: 0;
      min-height: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sheqmeni-preview-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      background: #f9fafb;
    }
    .sheqmeni-preview-frame {
      flex: 1;
      width: 100%;
      border: none;
      background: #f3f4f6;
    }
    .sheqmeni-box {
      width: 100%;
      max-width: 300px;
      min-height: 0;
      align-self: stretch;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      overflow: hidden;
    }
    .sheqmeni-chat {
      display: flex;
      flex: 1;
      flex-direction: column;
      min-height: 0;
      padding: 0;
    }
    .sheqmeni-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }
    @keyframes sheqmeni-msg-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .sheqmeni-msg {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 14px;
      line-height: 1.5;
      font-size: 15px;
      white-space: pre-wrap;
      word-break: break-word;
      animation: sheqmeni-msg-fade-in 0.35s ease-out;
    }
    .sheqmeni-msg.user {
      align-self: flex-end;
      background-color: #315EFF;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .sheqmeni-msg.ai {
      align-self: flex-start;
      background-color: #F5F8FF;
      color: #151515;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
    }
    .sheqmeni-typing {
      align-self: flex-start;
      padding: 12px 20px;
      background-color: #F5F8FF;
      border-radius: 14px;
      border-bottom-left-radius: 4px;
      color: #6B7280;
      font-size: 14px;
    }
    .sheqmeni-form {
      flex-shrink: 0;
      padding: 12px;
      border-top: 1px solid #e2e8f0;
      background: white;
      border-radius: 0 0 16px 16px;
    }
    .sheqmeni-form-inner {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .sheqmeni-input {
      flex: 1;
      min-height: 7.5em;
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      overflow: hidden;
      font-family: inherit;
      background: #F8F9FA;
      color: #151515;
    }
    .sheqmeni-input:focus {
      outline: none;
      border-color: #315EFF;
      background: white;
    }
    .sheqmeni-send {
      flex-shrink: 0;
      padding: 10px 20px;
      font-size: 15px;
      font-weight: 500;
      color: white;
      background-color: #315EFF;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .sheqmeni-send:hover:not(:disabled) {
      background-color: #2849d9;
    }
    .sheqmeni-send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Mobile layout: chat at top, CV preview below; buttons stacked */
    @media (max-width: 768px) {
      .sheqmeni-page {
        height: auto;
      }
      .sheqmeni-main {
        flex-direction: column;
        align-items: stretch;
        padding: 0.75rem;
      }
      .sheqmeni-box {
        max-width: 100%;
        height: 400px;
      }
      .sheqmeni-chat {
        height: 100%;
      }
      .sheqmeni-messages {
        flex: 1;
      }
      .sheqmeni-preview {
        flex: 0 0 auto;
        min-height: 50vh;
        overflow: auto;
      }
      .sheqmeni-preview-frame {
        /* Make the CV look like a zoomed-out PDF thumbnail */
        width: 120%;
        height: 520px;
        transform: scale(0.8);
        transform-origin: top center;
      }
      .sheqmeni-preview-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .sheqmeni-preview-header .sheqmeni-header-actions {
        flex-direction: column;
        width: 100%;
        gap: 8px;
      }
      .sheqmeni-preview-header .sheqmeni-header-actions button,
      .sheqmeni-preview-header .sheqmeni-header-actions input[type="color"] {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      .sheqmeni-preview-header .sheqmeni-header-actions input[type="color"] {
        height: 44px;
      }
    }
  </style>
</head>
<body class="text-secondary bg-[#F8F9FA]">
  <%- include('partials/gtm-noscript') %>
  <%- include('partials/header') %>

  <% if (!user) { %>
  <main class="w-full max-w-3xl mx-auto px-4 py-10">
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 text-center">
      <h1 class="text-xl font-medium text-[#151515] mb-3">CV-ის შესაქმნელად საჭიროა ავტორიზაცია</h1>
      <p class="text-sm text-gray-600 mb-6">გაგრძელებისთვის შედი სისტემაში Google / Gmail ანგარიშით.</p>
      <button
        type="button"
        class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-[#2563eb] text-white hover:bg-[#1d4ed8] text-sm font-medium cursor-pointer"
        onclick="var btn=document.getElementById('headerGoogleLoginBtn'); if (btn) btn.click();"
      >
        Google-ით ავტორიზაცია
      </button>
    </div>
  </main>
  <% } else { %>
  <p class="text-sm text-gray-600 mb-4 max-w-[600px] p-4">ხელ.ინტელექტი დაუშვებს შეცდომებს, ამიტომ შეუსწორეთ. შეგიძლიათ მიუთითოთ, რომ შეცვალოს ინფორმაცია ნებისმიერ სექციაში, სადაც არ მოგწონთ დაგენერირებული ინფორმაცია.</p>
  <div class="sheqmeni-page">
    <main class="sheqmeni-main" id="sheqmeniMain">
      <div class="sheqmeni-box" id="sheqmeniBox">
        <div class="sheqmeni-chat" id="sheqmeniChat">
          <div class="sheqmeni-messages" id="sheqmeniMessages">
            <div class="sheqmeni-msg ai">მე რამდენიმე კითხვას დაგისვამ, და შემდეგ გაგიკეთებ რეზიუმეს შენი პასუხების მიხედვით. დავიწყოთ?</div>
          </div>
          <div class="sheqmeni-typing" id="sheqmeniTyping" style="display: none;">ფიქრობს...</div>
          <form class="sheqmeni-form" id="sheqmeniForm">
            <div class="sheqmeni-form-inner flex flex-col items-stretch">
              <textarea
                class="sheqmeni-input w-full"
                id="sheqmeniInput"
                placeholder="თქვენი ტექსტი"
                rows="3"
                autocomplete="off"
              ></textarea>
              <button type="submit" class="sheqmeni-send w-full mb-2" id="sheqmeniSend">გაგზავნა</button>
              <button
                type="button"
                class="sheqmeni-send w-full bg-gray-100 text-gray-800 hover:bg-gray-200"
                id="sheqmeniHelpBtn"
              >
                დამეხმარეთ, ვერ ვაკეთებ
              </button>
            </div>
          </form>
          <div
            id="sheqmeniHelpPanel"
            class="mt-3 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg p-3 flex flex-col gap-3"
            style="display: none; max-height: 220px; overflow-y: auto;"
          >
            <!-- TODO: replace with final text provided by Giorgi -->
            <p>
              ერთიანად არ დაწეროთ ყველაფერი, მიჰყევით სათითაოდ. ენები, განათლება, სამუშაო გამოცდილება ( ცალცალკე დაწერეთ გამოცდილების შესახებ ).
              ნუ დაელოდებით როდის მიხვდება ხელ.ინტელექტი რამეს, თავად უბრძანეთ თუ რამე არ მოგწონთ, ან შეუსწორეთ რამე თუ ეშლება.
            </p>
            <div class="flex justify-end">
              <button
                type="button"
                id="sheqmeniHelpOkBtn"
                class="px-3 py-1.5 rounded-md bg-[#315EFF] text-white text-xs font-medium hover:bg-[#274bcc]"
              >
                კარგი, გასაგებია
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="sheqmeni-preview">
        <div class="sheqmeni-preview-header" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <span>აქ გამოჩნდება თქვენი რეზიუმე</span>
          <div class="sheqmeni-header-actions" style="display:flex;align-items:center;gap:6px;">
            <button id="changeColorBtn" type="button" style="font-size:12px;padding:6px 10px;border-radius:6px;border:1px solid #4b5563;background:#F9FAFB;color:#111827;cursor:pointer;white-space:nowrap;">
              CV ფერის ცვლილება
            </button>
            <input id="cvColorPicker" type="color" value="#8fbc8f" style="width:32px;height:32px;border-radius:6px;border:1px solid #D1D5DB;padding:0;background:#fff;cursor:pointer;" />
            <% if (user && user.user_type === 'user') { %>
            <button id="saveResumeBtn" style="font-size:12px;padding:6px 10px;border-radius:6px;border:1px solid #4b5563;background:#315EFF;color:#fff;cursor:pointer;white-space:nowrap;">
              რეზიუმეს დამახსოვრება
            </button>
            <% } %>
          </div>
        </div>
        <iframe id="cvPreviewFrame" class="sheqmeni-preview-frame"></iframe>
      </div>
    </main>
  </div>
  <div id="cvPdfSource" style="position:fixed;left:-9999px;top:0;width:210mm;min-height:297mm;padding:20mm;font-family:'Noto Sans Georgian PDF','Noto Sans Georgian',sans-serif;font-size:12px;line-height:1.6;color:#111;background:#fff;pointer-events:none;z-index:-1;"></div>

  <script>
    (function() {
      var messages = document.getElementById('sheqmeniMessages');
      var typing = document.getElementById('sheqmeniTyping');
      var form = document.getElementById('sheqmeniForm');
      var input = document.getElementById('sheqmeniInput');
      var sendBtn = document.getElementById('sheqmeniSend');
      var cvPreviewFrame = document.getElementById('cvPreviewFrame');
      var cvPdfSource = document.getElementById('cvPdfSource');
      var cvMessages = [];
      var currentPdfUrl = null;
      var cvData = {
        name: '',
        surname: '',
        email: '',
        phone: '',
        city: '',
        education: '',
        experience: '',
        skills: '',
        summary: '',
        profession: '',
        themeColor: '',
        jobs: [],
        languages: [],
        certificates: [],
        otherInfo: ''
      };
      var currentUserUid = "<%= user && user.uid ? user.uid : '' %>";
      var existingCvHtml = <%- JSON.stringify(typeof existingCvHtml !== 'undefined' ? existingCvHtml : '') %>;
      var changeColorBtn = document.getElementById('changeColorBtn');
      var cvColorPicker = document.getElementById('cvColorPicker');

      // If user already has a generated CV, show it in the preview iframe
      if (existingCvHtml && cvPreviewFrame) {
        var docInit = cvPreviewFrame.contentDocument || cvPreviewFrame.contentWindow.document;
        if (docInit) {
          docInit.open();
          docInit.write(existingCvHtml);
          docInit.close();
        }
      }

      // Initialize theme color from picker into cvData
      if (cvColorPicker) {
        cvData.themeColor = cvColorPicker.value || '#8fbc8f';
        cvColorPicker.addEventListener('change', function() {
          cvData.themeColor = cvColorPicker.value || '#8fbc8f';
          updateCvPreview();
        });
      }
      if (changeColorBtn && cvColorPicker) {
        changeColorBtn.addEventListener('click', function() {
          cvColorPicker.focus();
          cvColorPicker.click();
        });
      }

      // Seed cvMessages with the initial AI message from HTML
      (function() {
        var firstAi = document.querySelector('.sheqmeni-messages .sheqmeni-msg.ai');
        if (firstAi && firstAi.textContent) {
          cvMessages.push({ role: 'ai', text: firstAi.textContent.trim() });
        }
      })();

      function scrollToEnd() {
        messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
      }

      function scrollToEndAfterLayout() {
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            scrollToEnd();
          });
        });
      }

      function mergeCvData(data) {
        if (!data || typeof data !== 'object') return;
        var scalarKeys = ['name','surname','email','phone','city','education','skills','summary','profession','themeColor','otherInfo'];
        scalarKeys.forEach(function(k) {
          if (data[k] != null && String(data[k]).trim()) {
            cvData[k] = String(data[k]).trim();
          }
        });
        if (Array.isArray(data.jobs) && data.jobs.length) {
          cvData.jobs = data.jobs;
        }
        if (Array.isArray(data.experience) && data.experience.length) {
          cvData.experience = data.experience;
        } else if (data.experience != null && typeof data.experience === 'string' && data.experience.trim()) {
          cvData.experience = data.experience.trim();
        }
        if (Array.isArray(data.languages) && data.languages.length) {
          cvData.languages = data.languages;
        }
        if (Array.isArray(data.certificates) && data.certificates.length) {
          cvData.certificates = data.certificates;
        }
      }

      function escapeHtml(s) {
        return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      function updateCvPreview() {
        if (!cvPreviewFrame) return;

        var hasAnyData = Object.values(cvData).some(function(v) {
          return v && String(v).trim();
        });
        if (!hasAnyData) return;

        var fullName = (cvData.name + ' ' + cvData.surname).trim() || '';
        var city = cvData.city || '';
        var summary = cvData.summary || '';
        var education = cvData.education || '';
        var rawExperience = cvData.experience;
        var experienceText = typeof rawExperience === 'string' ? rawExperience : '';
        var skillsArray = (cvData.skills || '')
          .split(',')
          .map(function(s) { return s.trim(); })
          .filter(function(s) { return s.length > 0; });

        var skillsHtml = skillsArray.map(function(s) {
          return '<div class="skill-item">' + escapeHtml(s) + '</div>';
        }).join('');

        var languagesList = [];
        if (Array.isArray(cvData.languages)) {
          languagesList = cvData.languages.map(function(lang) {
            lang = lang || {};
            return {
              name: (lang.name || lang.language || '').trim(),
              level: (lang.level || lang.proficiency || '').trim()
            };
          }).filter(function(lang) { return lang.name; });
        } else if (typeof cvData.languages === 'string' && cvData.languages.trim()) {
          languagesList = cvData.languages.split(',').map(function(s) {
            return { name: s.trim(), level: '' };
          }).filter(function(lang) { return lang.name; });
        }

        var languagesHtml = languagesList.map(function(lang) {
          var label = escapeHtml(lang.name);
          if (lang.level) {
            label += ' — ' + escapeHtml(lang.level);
          }
          return '<div class="skill-item">' + label + '</div>';
        }).join('');

        var certificatesArray = Array.isArray(cvData.certificates) ? cvData.certificates : [];
        var certificatesHtml = certificatesArray.map(function(cert) {
          cert = cert || {};
          var title = cert.name || cert.title || '';
          var issuer = cert.issuer || cert.organization || '';
          var year = cert.year || '';
          var line = escapeHtml(title);
          var metaParts = [];
          if (issuer) metaParts.push(escapeHtml(issuer));
          if (year) metaParts.push(escapeHtml(year));
          if (metaParts.length) {
            line += ' (' + metaParts.join(', ') + ')';
          }
          return '<div class="skill-item">' + line + '</div>';
        }).join('');

        var otherInfo = cvData.otherInfo || '';

        var hasSummary = !!(summary && String(summary).trim());
        var hasEducation = !!(education && String(education).trim());
        var hasJobsSection = !!(jobsHtml && String(jobsHtml).trim());
        var hasSkills = !!(skillsHtml && String(skillsHtml).trim());
        var hasLanguages = !!(languagesHtml && String(languagesHtml).trim());
        var hasCertificates = !!(certificatesHtml && String(certificatesHtml).trim());
        var hasOtherInfo = !!(otherInfo && String(otherInfo).trim());

        var jobsHtml = '';
        var jobsSource = Array.isArray(cvData.jobs) ? cvData.jobs
          : (Array.isArray(cvData.experience) ? cvData.experience : null);
        if (jobsSource && jobsSource.length) {
          jobsHtml = jobsSource.map(function(j) {
            j = j || {};
            var company = j.company || '';
            var position = j.position || '';
            var start = j.start_date || '';
            var end = j.end_date || '';
            var jobSummary = j.summary || '';
            var duties = j.duties;
            var dutySource = '';
            if (Array.isArray(duties)) {
              dutySource = duties.join('\n');
            } else if (typeof duties === 'string') {
              dutySource = duties;
            } else if (duties != null) {
              dutySource = String(duties);
            }
            var dateRange = (start || end) ? (escapeHtml(start) + (end ? ' — ' + escapeHtml(end) : '')) : '';
            var dutyLines = (dutySource || '').split(/\r?\n/).map(function(t){return t.trim();}).filter(Boolean);
            if (!dutyLines.length && jobSummary) dutyLines = [jobSummary];
            var bullets = dutyLines.map(function(line) {
              return '<li>' + escapeHtml(line) + '</li>';
            }).join('');
            if (!bullets && experienceText) {
              bullets = '<li>' + escapeHtml(experienceText) + '</li>';
            }
            return ''
              + '<div class="job">'
              + '  <div class="job-header">'
              + '    <span class="job-company">' + escapeHtml(company || 'კომპანია') + '</span>'
              + '    <span class="job-location"></span>'
              + '  </div>'
              + '  <div class="job-sub">'
              + '    <span class="job-title">' + escapeHtml(position || '') + '</span>'
              + '    <span class="job-dates">' + dateRange + '</span>'
              + '  </div>'
              + '  <ul class="job-bullets">' + bullets + '</ul>'
              + '</div>';
          }).join('');
        } else if (experienceText) {
          jobsHtml = ''
            + '<div class="job">'
            + '  <div class="job-header">'
            + '    <span class="job-company">გამოცდილება</span>'
            + '    <span class="job-location"></span>'
            + '  </div>'
            + '  <div class="job-sub">'
            + '    <span class="job-title"></span>'
            + '    <span class="job-dates"></span>'
            + '  </div>'
            + '  <ul class="job-bullets"><li>' + escapeHtml(experienceText) + '</li></ul>'
            + '</div>';
        }

        hasJobsSection = !!(jobsHtml && String(jobsHtml).trim());

        var summarySectionHtml = '';
        if (hasSummary) {
          summarySectionHtml =
              '    <div class="section">'
            + '      <div class="section-header">'
            + '        <div class="section-icon">'
            + '          <svg viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>'
            + '        </div>'
            + '        <span class="section-title">მოკლე აღწერა</span>'
            + '      </div>'
            + '      <p class="summary-text">' + escapeHtml(summary || '') + '</p>'
            + '    </div>';
        }

        var workSectionHtml = '';
        if (hasJobsSection) {
          workSectionHtml =
              '    <div class="section">'
            + '      <div class="section-header">'
            + '        <div class="section-icon">'
            + '          <svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.07-.44.18-.88.18-1.34C18 2.54 15.96.5 13.46.5c-1.36 0-2.5.56-3.46 1.44C9.04 1.06 7.9.5 6.54.5 4.04.5 2 2.54 2 4.66c0 .46.11.9.18 1.34H0v14c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7.46-3.5c1.29 0 2.46 1.06 2.46 2.16 0 .44-.07.88-.18 1.34H12V4.68c.29-.94.84-2.18 2.54-2.18.37 0 .93.11.93.11zM7 2.5c1.7 0 2.25 1.24 2.54 2.18V6.5H6.18c-.11-.46-.18-.9-.18-1.34C6 3.56 7.04 2.5 7.04 2.5H7zM2 8h20v4H2V8zm0 12v-6h8v2h4v-2h8v6H2z"/></svg>'
            + '        </div>'
            + '        <span class="section-title">სამუშაო გამოცდილება</span>'
            + '      </div>'
            +          jobsHtml +
            '    </div>';
        }

        var educationSectionHtml = '';
        if (hasEducation) {
          educationSectionHtml =
              '    <div class="section">'
            + '      <div class="section-header">'
            + '        <div class="section-icon">'
            + '          <svg viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18V15c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-3.82L23 9 12 3zm6 12H6v-3.27l6 3.27 6-3.27V15zm-6-5.18L4.53 9 12 5.18 19.47 9 12 9.82z"/></svg>'
            + '        </div>'
            + '        <span class="section-title">განათლება</span>'
            + '      </div>'
            + '      <div class="edu-school">' + escapeHtml(education || '') + '</div>'
            + '    </div>';
        }

        var certificatesSectionHtml = '';
        if (hasCertificates) {
          certificatesSectionHtml =
              '    <div class="section">'
            + '      <div class="section-header">'
            + '        <div class="section-icon">'
            + '          <svg viewBox="0 0 24 24"><path d="M12 2l3.5 7.1 7.8 1.1-5.6 5.4 1.3 7.7L12 18.8 5 21.3l1.3-7.7-5.6-5.4 7.8-1.1z"/></svg>'
            + '        </div>'
            + '        <span class="section-title">სერტიფიკატები</span>'
            + '      </div>'
            +          certificatesHtml +
            '    </div>';
        }

        var otherInfoSectionHtml = '';
        if (hasOtherInfo) {
          otherInfoSectionHtml =
              '    <div class="section">'
            + '      <div class="section-header">'
            + '        <div class="section-icon">'
            + '          <svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 5.6 2 10c0 2.5 1.5 4.7 3.8 6.2L5 22l4.4-2.4c.8.1 1.5.2 2.3.2 5.5 0 10-3.6 10-8s-4.5-8-10-8zm1 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>'
            + '        </div>'
            + '        <span class="section-title">სხვა ინფორმაცია</span>'
            + '      </div>'
            + '      <p class="summary-text">' + escapeHtml(otherInfo || '') + '</p>'
            + '    </div>';
        }

        var skillsSectionHtml = '';
        if (hasSkills) {
          skillsSectionHtml =
              '    <div class="sidebar-section">'
            + '      <div class="sidebar-title">'
            + '        <div class="icon-box">'
            + '          <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'
            + '        </div>'
            + '        უნარები'
            + '      </div>'
            +          skillsHtml +
            '    </div>';
        }

        var languagesSectionHtml = '';
        if (hasLanguages) {
          languagesSectionHtml =
              '    <div class="sidebar-section">'
            + '      <div class="sidebar-title">'
            + '        <div class="icon-box">'
            + '          <svg viewBox="0 0 24 24"><path d="M4 4h16v2H5v3H3V5c0-.6.4-1 1-1zm3 5h14c.6 0 1 .4 1 1v9c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1v-9c0-.6.4-1 1-1zm7 2l-3 7h2l.6-1.5h2.8L18 18h2l-3-7h-2zm-1 4l.9-2.2L15.8 15H13z"/></svg>'
            + '        </div>'
            + '        ენები'
            + '      </div>'
            +          languagesHtml +
            '    </div>';
        }

        var doc = cvPreviewFrame.contentDocument || cvPreviewFrame.contentWindow.document;
        if (!doc) return;

        var primaryPosition = (jobsSource && jobsSource.length && jobsSource[0] && jobsSource[0].position) ? jobsSource[0].position : '';
        var profession = cvData.profession || '';
        var badgeText = profession || primaryPosition || (summary ? summary.slice(0, 80) : 'პროფესიული რეზიუმე');

        var themeColor = (cvData.themeColor || '').trim() || '#8fbc8f';
        var lowerColor = themeColor.toLowerCase();
        var badgeTextColor = (lowerColor === '#ffffff' || lowerColor === '#fff' || lowerColor === 'white') ? '#111111' : '#ffffff';

        var html = ''
          + '<!DOCTYPE html>'
          + '<html lang="ka">'
          + '<head>'
          + '<meta charset="UTF-8">'
          + '<meta name="viewport" content="width=device-width, initial-scale=1.0">'
          + '<title>' + escapeHtml(fullName || 'რეზიუმე') + '</title>'
          + '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;600;700&family=Raleway:wght@400;600;700;800&display=swap" rel="stylesheet">'
          + '<style>'
          + '*{margin:0;padding:0;box-sizing:border-box;}'
          + 'body{font-family:\'Raleway\',\'Noto Sans Georgian\',sans-serif;background:#ffffff;margin:0;padding:0;}'
          + '.page{background:#fff;width:100%;min-height:100vh;display:flex;}'
          + '.sidebar{width:260px;min-width:260px;background:#f7f7f7;padding:40px 28px;border-right:1px solid #eee;}'
          + '.sidebar-section{margin-bottom:36px;}'
          + '.sidebar-title{display:flex;align-items:center;gap:10px;font-size:13px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:#2d2d2d;margin-bottom:18px;}'
          + '.icon-box{width:32px;height:32px;background:' + themeColor + ';border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}'
          + '.icon-box svg{width:16px;height:16px;fill:#fff;}'
          + '.contact-item{display:flex;align-items:flex-start;gap:10px;margin-bottom:14px;font-size:13px;color:' + themeColor + ';line-height:1.4;}'
          + '.contact-item svg{width:16px;height:16px;fill:' + themeColor + ';flex-shrink:0;margin-top:1px;}'
          + '.skill-item{display:flex;align-items:center;gap:8px;font-size:13px;color:#444;margin-bottom:10px;}'
          + '.skill-item::before{content:"•";color:#5a8a5a;font-size:16px;}'
          + '.main{flex:1;padding:40px 44px;}'
          + '.name{font-size:42px;font-weight:800;color:#1a1a1a;letter-spacing:-1px;line-height:1;margin-bottom:16px;text-transform:capitalize;}'
          + '.title-badge{display:inline-block;background:' + themeColor + ';color:' + badgeTextColor + ';font-family:\'Noto Sans Georgian\',sans-serif;font-size:14px;font-weight:600;padding:10px 24px;border-radius:6px;margin-bottom:36px;width:100%;text-align:left;}'
          + '.section{margin-bottom:34px;}'
          + '.section-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;border-bottom:1px solid #eee;padding-bottom:10px;}'
          + '.section-icon{width:34px;height:34px;background:' + themeColor + ';border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}'
          + '.section-icon svg{width:18px;height:18px;fill:#fff;}'
          + '.section-title{font-size:14px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:#1a1a1a;}'
          + '.summary-text{font-size:13.5px;color:#444;line-height:1.7;}'
          + '.job{margin-bottom:18px;}'
          + '.job-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px;}'
          + '.job-company{font-family:\'Noto Sans Georgian\',sans-serif;font-weight:700;font-size:14px;color:#2d2d2d;}'
          + '.job-location{font-family:\'Noto Sans Georgian\',sans-serif;font-size:13px;color:#666;}'
          + '.job-sub{display:flex;justify-content:space-between;margin-bottom:10px;}'
          + '.job-title{font-family:\'Noto Sans Georgian\',sans-serif;font-size:13px;color:#555;}'
          + '.job-dates{font-size:13px;color:#666;}'
          + '.job-bullets{list-style:none;padding:0;}'
          + '.job-bullets li{font-size:13.5px;color:#444;line-height:1.6;padding-left:16px;position:relative;margin-bottom:6px;}'
          + '.job-bullets li::before{content:"•";position:absolute;left:0;color:#5a8a5a;font-size:16px;line-height:1.4;}'
          + '.edu-school{font-family:\'Noto Sans Georgian\',sans-serif;font-weight:700;font-size:14px;color:#2d2d2d;}'
          + '</style>'
          + '</head>'
          + '<body>'
          + '<div class="page">'
          + '  <div class="sidebar">'
          + '    <div class="sidebar-section">'
          + '      <div class="sidebar-title">'
          + '        <div class="icon-box">'
          + '          <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'
          + '        </div>'
          + '        საკონტაქტო ინფორმაცია'
          + '      </div>'
          + '      <div class="contact-item">'
          + '        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5 14.5 7.62 14.5 9 13.38 11.5 12 11.5z"/></svg>'
          +          escapeHtml(city || '')
          + '      </div>'
          + '      <div class="contact-item">'
          + '        <svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg>'
          +          escapeHtml(cvData.phone || '') +
          '      </div>'
          + '      <div class="contact-item">'
          + '        <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'
          +          escapeHtml(cvData.email || '') +
          '      </div>'
          + '    </div>'
          +        skillsSectionHtml
          +        languagesSectionHtml
          + '  </div>'
          + '  <div class="main">'
          + '    <h1 class="name">' + escapeHtml(fullName || '') + '</h1>'
          + '    <div class="title-badge">' + escapeHtml(badgeText || '') + '</div>'
          +        summarySectionHtml
          +        workSectionHtml
          +        educationSectionHtml
          +        certificatesSectionHtml
          +        otherInfoSectionHtml
          + '  </div>'
          + '</div>'
          + '</body></html>';

        doc.open();
        doc.write(html);
        doc.close();
      }

      function addMessage(text, role) {
        var div = document.createElement('div');
        div.className = 'sheqmeni-msg ' + role;
        div.textContent = text;
        messages.appendChild(div);
        cvMessages.push({ role: role, text: text });
        updateCvPreview();
        scrollToEndAfterLayout();
        setTimeout(scrollToEnd, 150);
      }

      var helpBtn = document.getElementById('sheqmeniHelpBtn');
      var helpPanel = document.getElementById('sheqmeniHelpPanel');
      var helpOkBtn = document.getElementById('sheqmeniHelpOkBtn');

      if (helpBtn && helpPanel) {
        helpBtn.addEventListener('click', function() {
          if (helpPanel.style.display === 'none' || !helpPanel.style.display) {
            helpPanel.style.display = 'block';
            scrollToEnd();
          } else {
            helpPanel.style.display = 'none';
          }
        });
      }

      if (helpOkBtn && helpPanel) {
        helpOkBtn.addEventListener('click', function() {
          helpPanel.style.display = 'none';
        });
      }

      function showTyping(show) {
        typing.style.display = show ? 'block' : 'none';
        if (show) scrollToEnd();
      }

      // Sync session with server so history has the first question (message already shown in HTML)
      function loadInitialQuestion() {
        fetch('/api/sheqmeni-cv/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initial: true })
        }).catch(function() {});
      }

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var text = (input.value || '').trim();
        if (!text) return;
        input.value = '';
        addMessage(text, 'user');
        sendBtn.disabled = true;
        showTyping(true);

        fetch('/api/sheqmeni-cv/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        })
          .then(function(r) {
            return r.json().then(function(data) {
              return { ok: r.ok, status: r.status, data: data };
            });
          })
          .then(function(result) {
            showTyping(false);
            if (!result.ok && result.data && result.data.error) {
              var errMsg = result.data.message || 'დაფიქსირდა შეცდომა. ეს არ არის samushao.ge-ის პრობლემა — AI სერვისის შეცდომაა. გთხოვთ სცადოთ თავიდან.';
              if (result.data.detail) {
                errMsg += ' (' + result.data.detail + ')';
              }
              addMessage(errMsg, 'ai');
              return;
            }
            var data = result.data;
            if (data.cvData) {
              mergeCvData(data.cvData);
              updateCvPreview();
            }
            addMessage(data.reply || '', 'ai');
          })
          .catch(function() {
            showTyping(false);
            addMessage('დაფიქსირდა შეცდომა. ეს არ არის samushao.ge-ის პრობლემა — AI სერვისის შეცდომაა. გთხოვთ სცადოთ თავიდან.', 'ai');
          })
          .then(function() {
            sendBtn.disabled = false;
            input.focus();
          });
      });

      var saveBtn = document.getElementById('saveResumeBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          if (!currentUserUid) {
            alert('რეზიუმეს შესანახად საჭიროა ავტორიზაცია.');
            return;
          }
          var hasAnyData = Object.values(cvData).some(function(v) {
            return v && String(v).trim();
          });
          if (!hasAnyData) {
            alert('ჯერ შეავსე ინფორმაცია, რომ რეზიუმე შევინახოთ.');
            return;
          }
          saveBtn.disabled = true;
          saveBtn.textContent = 'ინახება...';

          fetch('/api/sheqmeni-cv/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cv: cvData })
          })
            .then(function(r) { return r.json(); })
            .then(function(data) {
              if (data && data.ok) {
                saveBtn.textContent = 'შენახულია';
              } else {
                throw new Error(data && data.error || 'save_failed');
              }
            })
            .catch(function() {
              saveBtn.disabled = false;
              saveBtn.textContent = 'რეზიუმეს დამახსოვრება';
              alert('რეზიუმეს შენახვა ვერ მოხერხდა. სცადე თავიდან.');
            });
        });
      }

      // Kick off conversation on load
      loadInitialQuestion();
    })();
  </script>
  <% } %>
</body>
</html>
